---
title: 'Registro e intercepción de operaciones de base de datos: EF6'
author: divega
ms.date: 10/23/2016
ms.assetid: b5ee7eb1-88cc-456e-b53c-c67e24c3f8ca
ms.openlocfilehash: 35b0284a5ad8b2b732f074589bd458d243312575
ms.sourcegitcommit: 708b18520321c587b2046ad2ea9fa7c48aeebfe5
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 10/09/2019
ms.locfileid: "72181672"
---
# <a name="logging-and-intercepting-database-operations"></a><span data-ttu-id="9eaa1-102">Registrar e interceptar operaciones de base de datos</span><span class="sxs-lookup"><span data-stu-id="9eaa1-102">Logging and intercepting database operations</span></span>
> [!NOTE]
> <span data-ttu-id="9eaa1-103">**Solo EF6 y versiones posteriores**: las características, las API, etc. que se tratan en esta página se han incluido a partir de Entity Framework 6.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-103">**EF6 Onwards Only** - The features, APIs, etc. discussed in this page were introduced in Entity Framework 6.</span></span> <span data-ttu-id="9eaa1-104">Si usa una versión anterior, no se aplica parte o la totalidad de la información.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-104">If you are using an earlier version, some or all of the information does not apply.</span></span>  

<span data-ttu-id="9eaa1-105">A partir de Entity Framework 6, en cualquier momento Entity Framework envía un comando a la base de datos. este comando puede ser interceptado por el código de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-105">Starting with Entity Framework 6, anytime Entity Framework sends a command to the database this command can be intercepted by application code.</span></span> <span data-ttu-id="9eaa1-106">Esto se usa normalmente para registrar SQL, pero también se puede usar para modificar o anular el comando.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-106">This is most commonly used for logging SQL, but can also be used to modify or abort the command.</span></span>  

<span data-ttu-id="9eaa1-107">En concreto, EF incluye:</span><span class="sxs-lookup"><span data-stu-id="9eaa1-107">Specifically, EF includes:</span></span>  

- <span data-ttu-id="9eaa1-108">Una propiedad de registro para el contexto similar a DataContext. log en LINQ to SQL</span><span class="sxs-lookup"><span data-stu-id="9eaa1-108">A Log property for the context similar to DataContext.Log in LINQ to SQL</span></span>  
- <span data-ttu-id="9eaa1-109">Mecanismo para personalizar el contenido y el formato de la salida enviada al registro.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-109">A mechanism to customize the content and formatting of the output sent to the log</span></span>  
- <span data-ttu-id="9eaa1-110">Bloques de creación de bajo nivel para la interceptación, lo que ofrece un mayor control y flexibilidad</span><span class="sxs-lookup"><span data-stu-id="9eaa1-110">Low-level building blocks for interception giving greater control/flexibility</span></span>  

## <a name="context-log-property"></a><span data-ttu-id="9eaa1-111">Propiedad de registro de contexto</span><span class="sxs-lookup"><span data-stu-id="9eaa1-111">Context Log property</span></span>  

<span data-ttu-id="9eaa1-112">La propiedad DbContext. Database. log se puede establecer en un delegado para cualquier método que toma una cadena.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-112">The DbContext.Database.Log property can be set to a delegate for any method that takes a string.</span></span> <span data-ttu-id="9eaa1-113">Normalmente, se usa con cualquier TextWriter estableciéndolo en el método "write" de ese TextWriter.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-113">Most commonly it is used with any TextWriter by setting it to the “Write” method of that TextWriter.</span></span> <span data-ttu-id="9eaa1-114">Todos los SQL generados por el contexto actual se registrarán en ese escritor.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-114">All SQL generated by the current context will be logged to that writer.</span></span> <span data-ttu-id="9eaa1-115">Por ejemplo, el código siguiente registrará SQL en la consola:</span><span class="sxs-lookup"><span data-stu-id="9eaa1-115">For example, the following code will log SQL to the console:</span></span>  

``` csharp
using (var context = new BlogContext())
{
    context.Database.Log = Console.Write;

    // Your code here...
}
```  

<span data-ttu-id="9eaa1-116">Tenga en cuenta ese contexto. Database. log se establece en Console. Write.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-116">Notice that context.Database.Log is set to Console.Write.</span></span> <span data-ttu-id="9eaa1-117">Esto es todo lo que se necesita para registrar SQL en la consola.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-117">This is all that is needed to log SQL to the console.</span></span>  

<span data-ttu-id="9eaa1-118">Vamos a agregar algunos códigos simples de consulta/inserción/actualización para que podamos ver algunos resultados:</span><span class="sxs-lookup"><span data-stu-id="9eaa1-118">Let’s add some simple query/insert/update code so that we can see some output:</span></span>  

``` csharp
using (var context = new BlogContext())
{
    context.Database.Log = Console.Write;

    var blog = context.Blogs.First(b => b.Title == "One Unicorn");

    blog.Posts.First().Title = "Green Eggs and Ham";

    blog.Posts.Add(new Post { Title = "I do not like them!" });

    context.SaveChangesAsync().Wait();
}
```  

<span data-ttu-id="9eaa1-119">Se generará el siguiente resultado:</span><span class="sxs-lookup"><span data-stu-id="9eaa1-119">This will generate the following output:</span></span>  

``` SQL
SELECT TOP (1)
    [Extent1].[Id] AS [Id],
    [Extent1].[Title] AS [Title]
    FROM [dbo].[Blogs] AS [Extent1]
    WHERE (N'One Unicorn' = [Extent1].[Title]) AND ([Extent1].[Title] IS NOT NULL)
-- Executing at 10/8/2013 10:55:41 AM -07:00
-- Completed in 4 ms with result: SqlDataReader

SELECT
    [Extent1].[Id] AS [Id],
    [Extent1].[Title] AS [Title],
    [Extent1].[BlogId] AS [BlogId]
    FROM [dbo].[Posts] AS [Extent1]
    WHERE [Extent1].[BlogId] = @EntityKeyValue1
-- EntityKeyValue1: '1' (Type = Int32)
-- Executing at 10/8/2013 10:55:41 AM -07:00
-- Completed in 2 ms with result: SqlDataReader

UPDATE [dbo].[Posts]
SET [Title] = @0
WHERE ([Id] = @1)
-- @0: 'Green Eggs and Ham' (Type = String, Size = -1)
-- @1: '1' (Type = Int32)
-- Executing asynchronously at 10/8/2013 10:55:41 AM -07:00
-- Completed in 12 ms with result: 1

INSERT [dbo].[Posts]([Title], [BlogId])
VALUES (@0, @1)
SELECT [Id]
FROM [dbo].[Posts]
WHERE @@ROWCOUNT > 0 AND [Id] = scope_identity()
-- @0: 'I do not like them!' (Type = String, Size = -1)
-- @1: '1' (Type = Int32)
-- Executing asynchronously at 10/8/2013 10:55:41 AM -07:00
-- Completed in 2 ms with result: SqlDataReader
```  

<span data-ttu-id="9eaa1-120">(Tenga en cuenta que esta es la salida, suponiendo que ya se ha producido cualquier inicialización de base de datos.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-120">(Note that this is the output assuming any database initialization has already happened.</span></span> <span data-ttu-id="9eaa1-121">Si aún no se ha producido la inicialización de la base de datos, habría mucha más salida mostrando todas las migraciones de trabajo en segundo plano para comprobar o crear una nueva base de datos.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-121">If database initialization had not already happened then there would be a lot more output showing all the work Migrations does under the covers to check for or create a new database.)</span></span>  

## <a name="what-gets-logged"></a><span data-ttu-id="9eaa1-122">¿Qué se registra?</span><span class="sxs-lookup"><span data-stu-id="9eaa1-122">What gets logged?</span></span>  

<span data-ttu-id="9eaa1-123">Cuando se establece la propiedad log, se registran todos los elementos siguientes:</span><span class="sxs-lookup"><span data-stu-id="9eaa1-123">When the Log property is set all of the following will be logged:</span></span>  

- <span data-ttu-id="9eaa1-124">SQL para todos los tipos de comandos diferentes.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-124">SQL for all different kinds of commands.</span></span> <span data-ttu-id="9eaa1-125">Por ejemplo:</span><span class="sxs-lookup"><span data-stu-id="9eaa1-125">For example:</span></span>  
    - <span data-ttu-id="9eaa1-126">Consultas, incluidas las consultas LINQ normales, las consultas eSQL y las consultas sin formato de métodos como SqlQuery</span><span class="sxs-lookup"><span data-stu-id="9eaa1-126">Queries, including normal LINQ queries, eSQL queries, and raw queries from methods such as SqlQuery</span></span>  
    - <span data-ttu-id="9eaa1-127">Inserciones, actualizaciones y eliminaciones generadas como parte de SaveChanges</span><span class="sxs-lookup"><span data-stu-id="9eaa1-127">Inserts, updates, and deletes generated as part of SaveChanges</span></span>  
    - <span data-ttu-id="9eaa1-128">Consultas de carga de relaciones como las generadas por la carga diferida</span><span class="sxs-lookup"><span data-stu-id="9eaa1-128">Relationship loading queries such as those generated by lazy loading</span></span>  
- <span data-ttu-id="9eaa1-129">Parámetros</span><span class="sxs-lookup"><span data-stu-id="9eaa1-129">Parameters</span></span>  
- <span data-ttu-id="9eaa1-130">Si el comando se ejecuta de forma asincrónica o no</span><span class="sxs-lookup"><span data-stu-id="9eaa1-130">Whether or not the command is being executed asynchronously</span></span>  
- <span data-ttu-id="9eaa1-131">Marca de tiempo que indica cuándo empezó A ejecutarse el comando.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-131">A timestamp indicating when the command started executing</span></span>  
- <span data-ttu-id="9eaa1-132">Si el comando se completó correctamente, se produjo un error al iniciar una excepción o, para Async, se canceló.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-132">Whether or not the command completed successfully, failed by throwing an exception, or, for async, was canceled</span></span>  
- <span data-ttu-id="9eaa1-133">Alguna indicación del valor del resultado</span><span class="sxs-lookup"><span data-stu-id="9eaa1-133">Some indication of the result value</span></span>  
- <span data-ttu-id="9eaa1-134">Cantidad aproximada de tiempo que se tardó en ejecutar el comando.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-134">The approximate amount of time it took to execute the command.</span></span> <span data-ttu-id="9eaa1-135">Tenga en cuenta que es el momento en el que se envía el comando para volver a obtener el objeto de resultado.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-135">Note that this is the time from sending the command to getting the result object back.</span></span> <span data-ttu-id="9eaa1-136">No incluye el tiempo para leer los resultados.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-136">It does not include time to read the results.</span></span>  

<span data-ttu-id="9eaa1-137">Al examinar la salida de ejemplo anterior, cada uno de los cuatro comandos registrados son:</span><span class="sxs-lookup"><span data-stu-id="9eaa1-137">Looking at the example output above, each of the four commands logged are:</span></span>  

- <span data-ttu-id="9eaa1-138">La consulta que resulta de la llamada a context. Blogs. First</span><span class="sxs-lookup"><span data-stu-id="9eaa1-138">The query resulting from the call to context.Blogs.First</span></span>  
    - <span data-ttu-id="9eaa1-139">Tenga en cuenta que el método ToString para obtener el SQL no habría funcionado para esta consulta porque "First" no proporciona un IQueryable en el que se podría llamar a ToString</span><span class="sxs-lookup"><span data-stu-id="9eaa1-139">Notice that the ToString method of getting the SQL would not have worked for this query since “First” does not provide an IQueryable on which ToString could be called</span></span>  
- <span data-ttu-id="9eaa1-140">La consulta que resulta de la carga diferida del blog. Publique</span><span class="sxs-lookup"><span data-stu-id="9eaa1-140">The query resulting from the lazy-loading of blog.Posts</span></span>  
    - <span data-ttu-id="9eaa1-141">Observe los detalles del parámetro para el valor de clave para el que se está produciendo la carga diferida.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-141">Notice the parameter details for the key value for which lazy loading is happening</span></span>  
    - <span data-ttu-id="9eaa1-142">Solo se registran las propiedades del parámetro que se establecen en valores no predeterminados.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-142">Only properties of the parameter that are set to non-default values are logged.</span></span> <span data-ttu-id="9eaa1-143">Por ejemplo, la propiedad Size solo se muestra si es distinto de cero.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-143">For example, the Size property is only shown if it is non-zero.</span></span>  
- <span data-ttu-id="9eaa1-144">Dos comandos resultantes de SaveChangesAsync; uno para la actualización para cambiar el título de una publicación, el otro para una inserción para agregar una nueva publicación</span><span class="sxs-lookup"><span data-stu-id="9eaa1-144">Two commands resulting from SaveChangesAsync; one for the update to change a post title, the other for an insert to add a new post</span></span>  
    - <span data-ttu-id="9eaa1-145">Tenga en cuenta los detalles de los parámetros de las propiedades de FK y title</span><span class="sxs-lookup"><span data-stu-id="9eaa1-145">Notice the parameter details for the FK and Title properties</span></span>  
    - <span data-ttu-id="9eaa1-146">Tenga en cuenta que estos comandos se ejecutan de forma asincrónica</span><span class="sxs-lookup"><span data-stu-id="9eaa1-146">Notice that these commands are being executed asynchronously</span></span>  

## <a name="logging-to-different-places"></a><span data-ttu-id="9eaa1-147">Registro en distintos lugares</span><span class="sxs-lookup"><span data-stu-id="9eaa1-147">Logging to different places</span></span>  

<span data-ttu-id="9eaa1-148">Como se indicó anteriormente, el registro en la consola es muy sencillo.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-148">As shown above logging to the console is super easy.</span></span> <span data-ttu-id="9eaa1-149">También es fácil de registrar en la memoria, el archivo, etc. mediante el uso de diferentes tipos de [TextWriter](https://msdn.microsoft.com/library/system.io.textwriter.aspx).</span><span class="sxs-lookup"><span data-stu-id="9eaa1-149">It’s also easy to log to memory, file, etc. by using different kinds of [TextWriter](https://msdn.microsoft.com/library/system.io.textwriter.aspx).</span></span>  

<span data-ttu-id="9eaa1-150">Si está familiarizado con LINQ to SQL podría observar que en LINQ to SQL la propiedad log está establecida en el objeto TextWriter real (por ejemplo, Console. out) mientras que en EF la propiedad log está establecida en un método que acepta una cadena (por ejemplo, , Console. Write o Console. out. Write).</span><span class="sxs-lookup"><span data-stu-id="9eaa1-150">If you are familiar with LINQ to SQL you might notice that in LINQ to SQL the Log property is set to the actual TextWriter object (for example, Console.Out) while in EF the Log property is set to a method that accepts a string (for example, Console.Write or Console.Out.Write).</span></span> <span data-ttu-id="9eaa1-151">El motivo es desacoplar EF de TextWriter mediante la aceptación de cualquier delegado que pueda actuar como receptor de cadenas.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-151">The reason for this is to decouple EF from TextWriter by accepting any delegate that can act as a sink for strings.</span></span> <span data-ttu-id="9eaa1-152">Por ejemplo, Imagine que ya tiene alguna plataforma de registro y que define un método de registro como el siguiente:</span><span class="sxs-lookup"><span data-stu-id="9eaa1-152">For example, imagine that you already have some logging framework and it defines a logging method like so:</span></span>  

``` csharp
public class MyLogger
{
    public void Log(string component, string message)
    {
        Console.WriteLine("Component: {0} Message: {1} ", component, message);
    }
}
```  

<span data-ttu-id="9eaa1-153">Se puede enlazar a la propiedad de registro EF de la siguiente manera:</span><span class="sxs-lookup"><span data-stu-id="9eaa1-153">This could be hooked up to the EF Log property like this:</span></span>  

``` csharp
var logger = new MyLogger();
context.Database.Log = s => logger.Log("EFApp", s);
```  

## <a name="result-logging"></a><span data-ttu-id="9eaa1-154">Registro de resultados</span><span class="sxs-lookup"><span data-stu-id="9eaa1-154">Result logging</span></span>  

<span data-ttu-id="9eaa1-155">El registrador predeterminado registra el texto del comando (SQL), los parámetros y la línea "en ejecución" con una marca de tiempo antes de que el comando se envíe a la base de datos.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-155">The default logger logs command text (SQL), parameters, and the “Executing” line with a timestamp before the command is sent to the database.</span></span> <span data-ttu-id="9eaa1-156">Una línea "completada" que contiene el tiempo transcurrido se registra después de la ejecución del comando.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-156">A “completed” line containing elapsed time is logged following execution of the command.</span></span>  

<span data-ttu-id="9eaa1-157">Tenga en cuenta que para los comandos asincrónicos, la línea "completada" no se registra hasta que la tarea asincrónica se complete realmente, se produzca un error o se cancele.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-157">Note that for async commands the “completed” line is not logged until the async task actually completes, fails, or is canceled.</span></span>  

<span data-ttu-id="9eaa1-158">La línea "completado" contiene información diferente en función del tipo de comando y de si la ejecución se realizó correctamente o no.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-158">The “completed” line contains different information depending on the type of command and whether or not execution was successful.</span></span>  

### <a name="successful-execution"></a><span data-ttu-id="9eaa1-159">Ejecución correcta</span><span class="sxs-lookup"><span data-stu-id="9eaa1-159">Successful execution</span></span>  

<span data-ttu-id="9eaa1-160">En el caso de los comandos que se completan correctamente, la salida es "Completed in x MS with result:" seguida de alguna indicación de cuál fue el resultado.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-160">For commands that complete successfully the output is “Completed in x ms with result: “ followed by some indication of what the result was.</span></span> <span data-ttu-id="9eaa1-161">Para los comandos que devuelven un lector de datos, la indicación de resultado es el tipo de [DbDataReader](https://msdn.microsoft.com/library/system.data.common.dbdatareader.aspx) devuelto.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-161">For commands that return a data reader the result indication is the type of [DbDataReader](https://msdn.microsoft.com/library/system.data.common.dbdatareader.aspx) returned.</span></span> <span data-ttu-id="9eaa1-162">En el caso de los comandos que devuelven un valor entero como el comando UPDATE mostrado sobre el resultado que se muestra es ese entero.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-162">For commands that return an integer value such as the update command shown above the result shown is that integer.</span></span>  

### <a name="failed-execution"></a><span data-ttu-id="9eaa1-163">Error de ejecución</span><span class="sxs-lookup"><span data-stu-id="9eaa1-163">Failed execution</span></span>  

<span data-ttu-id="9eaa1-164">En el caso de los comandos que producen un error iniciando una excepción, la salida contiene el mensaje de la excepción.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-164">For commands that fail by throwing an exception, the output contains the message from the exception.</span></span> <span data-ttu-id="9eaa1-165">Por ejemplo, el uso de SqlQuery para realizar consultas en una tabla que existe producirá una salida de registro similar a la siguiente:</span><span class="sxs-lookup"><span data-stu-id="9eaa1-165">For example, using SqlQuery to query against a table that does exist will result in log output something like this:</span></span>  

``` SQL
SELECT * from ThisTableIsMissing
-- Executing at 5/13/2013 10:19:05 AM
-- Failed in 1 ms with error: Invalid object name 'ThisTableIsMissing'.
```  

### <a name="canceled-execution"></a><span data-ttu-id="9eaa1-166">Ejecución cancelada</span><span class="sxs-lookup"><span data-stu-id="9eaa1-166">Canceled execution</span></span>  

<span data-ttu-id="9eaa1-167">En el caso de los comandos Async en los que se cancela la tarea, el resultado podría ser un error con una excepción, ya que esto es lo que suele hacer el proveedor ADO.NET subyacente cuando se intenta cancelar.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-167">For async commands where the task is canceled the result could be failure with an exception, since this is what the underlying ADO.NET provider often does when an attempt is made to cancel.</span></span> <span data-ttu-id="9eaa1-168">Si esto no ocurre y la tarea se cancela correctamente, la salida tendrá un aspecto similar al siguiente:</span><span class="sxs-lookup"><span data-stu-id="9eaa1-168">If this doesn’t happen and the task is canceled cleanly then the output will look something like this:</span></span>  

```console
update Blogs set Title = 'No' where Id = -1
-- Executing asynchronously at 5/13/2013 10:21:10 AM
-- Canceled in 1 ms
```  

## <a name="changing-log-content-and-formatting"></a><span data-ttu-id="9eaa1-169">Cambiar el contenido y el formato del registro</span><span class="sxs-lookup"><span data-stu-id="9eaa1-169">Changing log content and formatting</span></span>  

<span data-ttu-id="9eaa1-170">En, la propiedad Database. log hace uso de un objeto DatabaseLogFormatter.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-170">Under the covers the Database.Log property makes use of a DatabaseLogFormatter object.</span></span> <span data-ttu-id="9eaa1-171">Este objeto enlaza eficazmente una implementación de IDbCommandInterceptor (consulte a continuación) a un delegado que acepta cadenas y DbContext.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-171">This object effectively binds an IDbCommandInterceptor implementation (see below) to a delegate that accepts strings and a DbContext.</span></span> <span data-ttu-id="9eaa1-172">Esto significa que se llama a los métodos de DatabaseLogFormatter antes y después de la ejecución de comandos por EF.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-172">This means that methods on DatabaseLogFormatter are called before and after the execution of commands by EF.</span></span> <span data-ttu-id="9eaa1-173">Estos métodos de DatabaseLogFormatter recopilan y dan formato al resultado del registro y lo envían al delegado.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-173">These DatabaseLogFormatter methods gather and format log output and send it to the delegate.</span></span>  

### <a name="customizing-databaselogformatter"></a><span data-ttu-id="9eaa1-174">Personalización de DatabaseLogFormatter</span><span class="sxs-lookup"><span data-stu-id="9eaa1-174">Customizing DatabaseLogFormatter</span></span>  

<span data-ttu-id="9eaa1-175">El cambio de lo que se registra y su formato se puede lograr creando una nueva clase que se deriva de DatabaseLogFormatter e invalida los métodos según corresponda.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-175">Changing what is logged and how it is formatted can be achieved by creating a new class that derives from DatabaseLogFormatter and overrides methods as appropriate.</span></span> <span data-ttu-id="9eaa1-176">Los métodos más comunes para invalidar son:</span><span class="sxs-lookup"><span data-stu-id="9eaa1-176">The most common methods to override are:</span></span>  

- <span data-ttu-id="9eaa1-177">LogCommand: invalide esto para cambiar el modo en que se registran los comandos antes de que se ejecuten.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-177">LogCommand – Override this to change how commands are logged before they are executed.</span></span> <span data-ttu-id="9eaa1-178">De forma predeterminada, LogCommand llama a LogParameter para cada parámetro; en su lugar, puede elegir hacer lo mismo en los parámetros de invalidación o de control de forma diferente.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-178">By default LogCommand calls LogParameter for each parameter; you may choose to do the same in your override or handle parameters differently instead.</span></span>  
- <span data-ttu-id="9eaa1-179">LogResult: invalide esto para cambiar el modo en que se registra el resultado de la ejecución de un comando.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-179">LogResult – Override this to change how the outcome from executing a command is logged.</span></span>  
- <span data-ttu-id="9eaa1-180">LogParameter: invalide esto para cambiar el formato y el contenido del registro de parámetros.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-180">LogParameter – Override this to change the formatting and content of parameter logging.</span></span>  

<span data-ttu-id="9eaa1-181">Por ejemplo, supongamos que deseamos registrar solo una línea antes de que cada comando se envíe a la base de datos.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-181">For example, suppose we wanted to log just a single line before each command is sent to the database.</span></span> <span data-ttu-id="9eaa1-182">Esto puede hacerse con dos invalidaciones:</span><span class="sxs-lookup"><span data-stu-id="9eaa1-182">This can be done with two overrides:</span></span>  

- <span data-ttu-id="9eaa1-183">Invalide LogCommand para dar formato y escribir la única línea de SQL</span><span class="sxs-lookup"><span data-stu-id="9eaa1-183">Override LogCommand to format and write the single line of SQL</span></span>  
- <span data-ttu-id="9eaa1-184">Invalide LogResult para no hacer nada.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-184">Override LogResult to do nothing.</span></span>  

<span data-ttu-id="9eaa1-185">El código tendría un aspecto similar al siguiente:</span><span class="sxs-lookup"><span data-stu-id="9eaa1-185">The code would look something like this:</span></span>

``` csharp
public class OneLineFormatter : DatabaseLogFormatter
{
    public OneLineFormatter(DbContext context, Action<string> writeAction)
        : base(context, writeAction)
    {
    }

    public override void LogCommand<TResult>(
        DbCommand command, DbCommandInterceptionContext<TResult> interceptionContext)
    {
        Write(string.Format(
            "Context '{0}' is executing command '{1}'{2}",
            Context.GetType().Name,
            command.CommandText.Replace(Environment.NewLine, ""),
            Environment.NewLine));
    }

    public override void LogResult<TResult>(
        DbCommand command, DbCommandInterceptionContext<TResult> interceptionContext)
    {
    }
}
```  

<span data-ttu-id="9eaa1-186">Para registrar la salida, simplemente llame al método Write, que enviará la salida al delegado de escritura configurado.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-186">To log output simply call the Write method which will send output to the configured write delegate.</span></span>  

<span data-ttu-id="9eaa1-187">(Tenga en cuenta que este código hace la eliminación simplista de los saltos de línea como ejemplo.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-187">(Note that this code does simplistic removal of line breaks just as an example.</span></span> <span data-ttu-id="9eaa1-188">Lo más probable es que no funcione bien para ver SQL complejo).</span><span class="sxs-lookup"><span data-stu-id="9eaa1-188">It will likely not work well for viewing complex SQL.)</span></span>  

### <a name="setting-the-databaselogformatter"></a><span data-ttu-id="9eaa1-189">Establecer DatabaseLogFormatter</span><span class="sxs-lookup"><span data-stu-id="9eaa1-189">Setting the DatabaseLogFormatter</span></span>  

<span data-ttu-id="9eaa1-190">Una vez que se ha creado una nueva clase DatabaseLogFormatter, debe registrarse con EF.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-190">Once a new DatabaseLogFormatter class has been created it needs to be registered with EF.</span></span> <span data-ttu-id="9eaa1-191">Esto se hace mediante la configuración basada en código.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-191">This is done using code-based configuration.</span></span> <span data-ttu-id="9eaa1-192">En pocas palabras, esto significa que se crea una nueva clase que se deriva de DbConfiguration en el mismo ensamblado que la clase DbContext y, después, se llama a SetDatabaseLogFormatter en el constructor de esta nueva clase.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-192">In a nutshell this means creating a new class that derives from DbConfiguration in the same assembly as your DbContext class and then calling SetDatabaseLogFormatter in the constructor of this new class.</span></span> <span data-ttu-id="9eaa1-193">Por ejemplo:</span><span class="sxs-lookup"><span data-stu-id="9eaa1-193">For example:</span></span>  

``` csharp
public class MyDbConfiguration : DbConfiguration
{
    public MyDbConfiguration()
    {
        SetDatabaseLogFormatter(
            (context, writeAction) => new OneLineFormatter(context, writeAction));
    }
}
```  

### <a name="using-the-new-databaselogformatter"></a><span data-ttu-id="9eaa1-194">Usar el nuevo DatabaseLogFormatter</span><span class="sxs-lookup"><span data-stu-id="9eaa1-194">Using the new DatabaseLogFormatter</span></span>  

<span data-ttu-id="9eaa1-195">Este nuevo DatabaseLogFormatter se usará siempre que se establezca Database. log.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-195">This new DatabaseLogFormatter will now be used anytime Database.Log is set.</span></span> <span data-ttu-id="9eaa1-196">Por lo tanto, la ejecución del código de la parte 1 generará ahora el siguiente resultado:</span><span class="sxs-lookup"><span data-stu-id="9eaa1-196">So, running the code from part 1 will now result in the following output:</span></span>  

```console
Context 'BlogContext' is executing command 'SELECT TOP (1) [Extent1].[Id] AS [Id], [Extent1].[Title] AS [Title]FROM [dbo].[Blogs] AS [Extent1]WHERE (N'One Unicorn' = [Extent1].[Title]) AND ([Extent1].[Title] IS NOT NULL)'
Context 'BlogContext' is executing command 'SELECT [Extent1].[Id] AS [Id], [Extent1].[Title] AS [Title], [Extent1].[BlogId] AS [BlogId]FROM [dbo].[Posts] AS [Extent1]WHERE [Extent1].[BlogId] = @EntityKeyValue1'
Context 'BlogContext' is executing command 'update [dbo].[Posts]set [Title] = @0where ([Id] = @1)'
Context 'BlogContext' is executing command 'insert [dbo].[Posts]([Title], [BlogId])values (@0, @1)select [Id]from [dbo].[Posts]where @@rowcount > 0 and [Id] = scope_identity()'
```  

## <a name="interception-building-blocks"></a><span data-ttu-id="9eaa1-197">Bloques de creación de interceptación</span><span class="sxs-lookup"><span data-stu-id="9eaa1-197">Interception building blocks</span></span>  

<span data-ttu-id="9eaa1-198">Hasta ahora hemos visto cómo usar DbContext. Database. log para registrar el SQL generado por EF.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-198">So far we have looked at how to use DbContext.Database.Log to log the SQL generated by EF.</span></span> <span data-ttu-id="9eaa1-199">Pero este código es realmente una fachada relativamente fina sobre algunos bloques de creación de bajo nivel para la interceptación más general.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-199">But this code is actually a relatively thin facade over some low-level building blocks for more general interception.</span></span>  

### <a name="interception-interfaces"></a><span data-ttu-id="9eaa1-200">Interfaces de interceptación</span><span class="sxs-lookup"><span data-stu-id="9eaa1-200">Interception interfaces</span></span>  

<span data-ttu-id="9eaa1-201">El código de intercepción se crea en torno al concepto de interfaces de interceptación.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-201">The interception code is built around the concept of interception interfaces.</span></span> <span data-ttu-id="9eaa1-202">Estas interfaces heredan de IDbInterceptor y definen métodos a los que se llama cuando EF realiza alguna acción.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-202">These interfaces inherit from IDbInterceptor and define methods that are called when EF performs some action.</span></span> <span data-ttu-id="9eaa1-203">La intención es tener una interfaz por cada tipo de objeto que se va a interceptar.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-203">The intent is to have one interface per type of object being intercepted.</span></span> <span data-ttu-id="9eaa1-204">Por ejemplo, la interfaz IDbCommandInterceptor define métodos a los que se llama antes de que EF realice una llamada a ExecuteNonQuery, ExecuteScalar, ExecuteReader y a los métodos relacionados.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-204">For example, the IDbCommandInterceptor interface defines methods that are called before EF makes a call to ExecuteNonQuery, ExecuteScalar, ExecuteReader, and related methods.</span></span> <span data-ttu-id="9eaa1-205">Del mismo modo, la interfaz define métodos a los que se llama cuando se completa cada una de estas operaciones.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-205">Likewise, the interface defines methods that are called when each of these operations completes.</span></span> <span data-ttu-id="9eaa1-206">La clase DatabaseLogFormatter que hemos examinado anteriormente implementa esta interfaz para registrar los comandos.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-206">The DatabaseLogFormatter class that we looked at above implements this interface to log commands.</span></span>  

### <a name="the-interception-context"></a><span data-ttu-id="9eaa1-207">El contexto de interceptación</span><span class="sxs-lookup"><span data-stu-id="9eaa1-207">The interception context</span></span>  

<span data-ttu-id="9eaa1-208">Si se examinan los métodos definidos en cualquiera de las interfaces del interceptor, es evidente que cada llamada recibe un objeto de tipo DbInterceptionContext o algún tipo derivado de este, como DbCommandInterceptionContext @ no__t-0 @ no__t-1.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-208">Looking at the methods defined on any of the interceptor interfaces it is apparent that every call is given an object of type DbInterceptionContext or some type derived from this such as DbCommandInterceptionContext\<\>.</span></span> <span data-ttu-id="9eaa1-209">Este objeto contiene información contextual sobre la acción que está llevando a cabo EF.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-209">This object contains contextual information about the action that EF is taking.</span></span> <span data-ttu-id="9eaa1-210">Por ejemplo, si la acción se realiza en nombre de un DbContext, el DbContext se incluye en el DbInterceptionContext.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-210">For example, if the action is being taken on behalf of a DbContext, then the DbContext is included in the DbInterceptionContext.</span></span> <span data-ttu-id="9eaa1-211">De forma similar, para los comandos que se ejecutan de forma asincrónica, la marca IsAsync se establece en DbCommandInterceptionContext.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-211">Similarly, for commands that are being executed asynchronously, the IsAsync flag is set on DbCommandInterceptionContext.</span></span>  

### <a name="result-handling"></a><span data-ttu-id="9eaa1-212">Control de resultados</span><span class="sxs-lookup"><span data-stu-id="9eaa1-212">Result handling</span></span>  

<span data-ttu-id="9eaa1-213">La clase DbCommandInterceptionContext @ no__t-0 @ no__t-1 contiene las propiedades denominados result, OriginalResult, Exception y OriginalException.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-213">The DbCommandInterceptionContext\<\> class contains a properties called Result, OriginalResult, Exception, and OriginalException.</span></span> <span data-ttu-id="9eaa1-214">Estas propiedades se establecen en NULL/Zero para las llamadas a los métodos de interceptación a los que se llama antes de que se ejecute la operación, es decir, para... Ejecutar métodos.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-214">These properties are set to null/zero for calls to the interception methods that are called before the operation is executed — that is, for the …Executing methods.</span></span> <span data-ttu-id="9eaa1-215">Si la operación se ejecuta y se realiza correctamente, result y OriginalResult se establecen en el resultado de la operación.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-215">If the operation is executed and succeeds, then Result and OriginalResult are set to the result of the operation.</span></span> <span data-ttu-id="9eaa1-216">Estos valores se pueden observar en los métodos de interceptación a los que se llama después de que se haya ejecutado la operación, es decir, en... Métodos ejecutados.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-216">These values can then be observed in the interception methods that are called after the operation has executed — that is, on the …Executed methods.</span></span> <span data-ttu-id="9eaa1-217">Del mismo modo, si se produce la operación, se establecerán las propiedades Exception y OriginalException.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-217">Likewise, if the operation throws, then the Exception and OriginalException properties will be set.</span></span>  

#### <a name="suppressing-execution"></a><span data-ttu-id="9eaa1-218">Suprimir la ejecución</span><span class="sxs-lookup"><span data-stu-id="9eaa1-218">Suppressing execution</span></span>  

<span data-ttu-id="9eaa1-219">Si un interceptor establece la propiedad de resultado antes de que se ejecute el comando (en una de las propiedades... Ejecutar métodos) entonces EF no intentará realmente ejecutar el comando, sino que solo usará el conjunto de resultados.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-219">If an interceptor sets the Result property before the command has executed (in one of the …Executing methods) then EF will not attempt to actually execute the command, but will instead just use the result set.</span></span> <span data-ttu-id="9eaa1-220">En otras palabras, el interceptor puede suprimir la ejecución del comando, pero el EF continúa como si se hubiera ejecutado el comando.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-220">In other words, the interceptor can suppress execution of the command but have EF continue as if the command had been executed.</span></span>  

<span data-ttu-id="9eaa1-221">Un ejemplo de cómo se podría usar esto es el procesamiento por lotes de comandos que se ha realizado tradicionalmente con un proveedor de ajuste.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-221">An example of how this might be used is the command batching that has traditionally been done with a wrapping provider.</span></span> <span data-ttu-id="9eaa1-222">El interceptor almacenaría el comando para su ejecución posterior como un lote, pero "fingiría" a EF que el comando se ejecutaba como normal.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-222">The interceptor would store the command for later execution as a batch but would “pretend” to EF that the command had executed as normal.</span></span> <span data-ttu-id="9eaa1-223">Tenga en cuenta que esto requiere más que esto para implementar el procesamiento por lotes, pero este es un ejemplo de cómo se puede usar el resultado de la interceptación.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-223">Note that it requires more than this to implement batching, but this is an example of how changing the interception result might be used.</span></span>  

<span data-ttu-id="9eaa1-224">La ejecución también se puede suprimir si se establece la propiedad Exception en una de las propiedades... Ejecutar métodos.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-224">Execution can also be suppressed by setting the Exception property in one of the …Executing methods.</span></span> <span data-ttu-id="9eaa1-225">Esto hace que EF continúe como si se produjera un error en la ejecución de la operación produciendo la excepción dada.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-225">This causes EF to continue as if execution of the operation had failed by throwing the given exception.</span></span> <span data-ttu-id="9eaa1-226">Por supuesto, esto puede hacer que la aplicación se bloquee, pero también puede ser una excepción transitoria o cualquier otra excepción controlada por EF.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-226">This may, of course, cause the application to crash, but it may also be a transient exception or some other exception that is handled by EF.</span></span> <span data-ttu-id="9eaa1-227">Por ejemplo, se puede usar en entornos de prueba para probar el comportamiento de una aplicación cuando se produce un error en la ejecución del comando.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-227">For example, this could be used in test environments to test the behavior of an application when command execution fails.</span></span>  

#### <a name="changing-the-result-after-execution"></a><span data-ttu-id="9eaa1-228">Cambiar el resultado después de la ejecución</span><span class="sxs-lookup"><span data-stu-id="9eaa1-228">Changing the result after execution</span></span>  

<span data-ttu-id="9eaa1-229">Si un interceptor establece la propiedad de resultado después de que se haya ejecutado el comando (en una de las propiedades... Métodos ejecutados) entonces EF usará el resultado cambiado en lugar del resultado que se devolvió realmente desde la operación.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-229">If an interceptor sets the Result property after the command has executed (in one of the …Executed methods) then EF will use the changed result instead of the result that was actually returned from the operation.</span></span> <span data-ttu-id="9eaa1-230">Del mismo modo, si un interceptor establece la propiedad Exception después de que se haya ejecutado el comando, EF producirá la excepción set como si la operación hubiera producido la excepción.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-230">Similarly, if an interceptor sets the Exception property after the command has executed, then EF will throw the set exception as if the operation had thrown the exception.</span></span>  

<span data-ttu-id="9eaa1-231">Un interceptor también puede establecer la propiedad Exception en null para indicar que no se debe producir ninguna excepción.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-231">An interceptor can also set the Exception property to null to indicate that no exception should be thrown.</span></span> <span data-ttu-id="9eaa1-232">Esto puede ser útil si se produce un error en la ejecución de la operación, pero el interceptor quiere que EF continúe como si la operación se hubiera realizado correctamente.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-232">This can be useful if execution of the operation failed but the interceptor wishes EF to continue as if the operation had succeeded.</span></span> <span data-ttu-id="9eaa1-233">Normalmente, esto también implica establecer el resultado para que EF tenga algún valor de resultado con el que trabajar mientras continúa.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-233">This usually also involves setting the Result so that EF has some result value to work with as it continues.</span></span>  

#### <a name="originalresult-and-originalexception"></a><span data-ttu-id="9eaa1-234">OriginalResult y OriginalException</span><span class="sxs-lookup"><span data-stu-id="9eaa1-234">OriginalResult and OriginalException</span></span>  

<span data-ttu-id="9eaa1-235">Después de que EF haya ejecutado una operación, establecerá las propiedades result y OriginalResult si la ejecución no produjo un error, o bien las propiedades Exception y OriginalException si se produce un error de ejecución con una excepción.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-235">After EF has executed an operation it will set either the Result and OriginalResult properties if execution did not fail or the Exception and OriginalException properties if execution failed with an exception.</span></span>  

<span data-ttu-id="9eaa1-236">Las propiedades OriginalResult y OriginalException son de solo lectura y solo las establece EF después de ejecutar realmente una operación.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-236">The OriginalResult and OriginalException properties are read-only and are only set by EF after actually executing an operation.</span></span> <span data-ttu-id="9eaa1-237">Los interceptores no pueden establecer estas propiedades.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-237">These properties cannot be set by interceptors.</span></span> <span data-ttu-id="9eaa1-238">Esto significa que cualquier interceptor puede distinguir entre una excepción o un resultado establecido por otro interceptor, en lugar de la excepción real o el resultado que se produjo cuando se ejecutó la operación.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-238">This means that any interceptor can distinguish between an exception or result that has been set by some other interceptor as opposed to the real exception or result that occurred when the operation was executed.</span></span>  

### <a name="registering-interceptors"></a><span data-ttu-id="9eaa1-239">Registro de interceptores</span><span class="sxs-lookup"><span data-stu-id="9eaa1-239">Registering interceptors</span></span>  

<span data-ttu-id="9eaa1-240">Una vez que se ha creado una clase que implementa una o varias interfaces de interceptación, se puede registrar con EF mediante la clase DbInterception.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-240">Once a class that implements one or more of the interception interfaces has been created it can be registered with EF using the DbInterception class.</span></span> <span data-ttu-id="9eaa1-241">Por ejemplo:</span><span class="sxs-lookup"><span data-stu-id="9eaa1-241">For example:</span></span>  

``` csharp
DbInterception.Add(new NLogCommandInterceptor());
```  

<span data-ttu-id="9eaa1-242">Los interceptores también se pueden registrar en el nivel de dominio de aplicación mediante el mecanismo de configuración basado en código DbConfiguration.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-242">Interceptors can also be registered at the app-domain level using the DbConfiguration code-based configuration mechanism.</span></span>  

### <a name="example-logging-to-nlog"></a><span data-ttu-id="9eaa1-243">Ejemplo: Registro en NLog</span><span class="sxs-lookup"><span data-stu-id="9eaa1-243">Example: Logging to NLog</span></span>  

<span data-ttu-id="9eaa1-244">Vamos a reunir todo esto en un ejemplo que usa IDbCommandInterceptor y [NLog](https://nlog-project.org/) para:</span><span class="sxs-lookup"><span data-stu-id="9eaa1-244">Let’s put all this together into an example that using IDbCommandInterceptor and [NLog](https://nlog-project.org/) to:</span></span>  

- <span data-ttu-id="9eaa1-245">Registrar una advertencia para cualquier comando que se ejecute de forma no asincrónica</span><span class="sxs-lookup"><span data-stu-id="9eaa1-245">Log a warning for any command that is executed non-asynchronously</span></span>  
- <span data-ttu-id="9eaa1-246">Registrar un error para cualquier comando que se produzca cuando se ejecute</span><span class="sxs-lookup"><span data-stu-id="9eaa1-246">Log an error for any command that throws when executed</span></span>  

<span data-ttu-id="9eaa1-247">Esta es la clase que realiza el registro, que se debe registrar como se muestra arriba:</span><span class="sxs-lookup"><span data-stu-id="9eaa1-247">Here’s the class that does the logging, which should be registered as shown above:</span></span>  

``` csharp
public class NLogCommandInterceptor : IDbCommandInterceptor
{
    private static readonly Logger Logger = LogManager.GetCurrentClassLogger();

    public void NonQueryExecuting(
        DbCommand command, DbCommandInterceptionContext<int> interceptionContext)
    {
        LogIfNonAsync(command, interceptionContext);
    }

    public void NonQueryExecuted(
        DbCommand command, DbCommandInterceptionContext<int> interceptionContext)
    {
        LogIfError(command, interceptionContext);
    }

    public void ReaderExecuting(
        DbCommand command, DbCommandInterceptionContext<DbDataReader> interceptionContext)
    {
        LogIfNonAsync(command, interceptionContext);
    }

    public void ReaderExecuted(
        DbCommand command, DbCommandInterceptionContext<DbDataReader> interceptionContext)
    {
        LogIfError(command, interceptionContext);
    }

    public void ScalarExecuting(
        DbCommand command, DbCommandInterceptionContext<object> interceptionContext)
    {
        LogIfNonAsync(command, interceptionContext);
    }

    public void ScalarExecuted(
        DbCommand command, DbCommandInterceptionContext<object> interceptionContext)
    {
        LogIfError(command, interceptionContext);
    }

    private void LogIfNonAsync<TResult>(
        DbCommand command, DbCommandInterceptionContext<TResult> interceptionContext)
    {
        if (!interceptionContext.IsAsync)
        {
            Logger.Warn("Non-async command used: {0}", command.CommandText);
        }
    }

    private void LogIfError<TResult>(
        DbCommand command, DbCommandInterceptionContext<TResult> interceptionContext)
    {
        if (interceptionContext.Exception != null)
        {
            Logger.Error("Command {0} failed with exception {1}",
                command.CommandText, interceptionContext.Exception);
        }
    }
}
```  

<span data-ttu-id="9eaa1-248">Observe cómo este código utiliza el contexto de interceptación para detectar cuándo un comando se ejecuta de forma no asincrónica y para detectar cuándo se produjo un error al ejecutar un comando.</span><span class="sxs-lookup"><span data-stu-id="9eaa1-248">Notice how this code uses the interception context to discover when a command is being executed non-asynchronously and to discover when there was an error executing a command.</span></span>  
