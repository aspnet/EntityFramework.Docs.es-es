---
title: 'Funcionamiento de las consultas: EF Core'
author: rowanmiller
ms.date: 09/26/2018
ms.assetid: de2e34cd-659b-4cab-b5ed-7a979c6bf120
uid: core/querying/how-query-works
ms.openlocfilehash: bc085755f39b1288f092a8b2df892c1bf82a89f1
ms.sourcegitcommit: 708b18520321c587b2046ad2ea9fa7c48aeebfe5
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 10/09/2019
ms.locfileid: "72186243"
---
# <a name="how-queries-work"></a><span data-ttu-id="94dcc-102">Funcionamiento de las consultas</span><span class="sxs-lookup"><span data-stu-id="94dcc-102">How Queries Work</span></span>

<span data-ttu-id="94dcc-103">Entity Framework Core usa Language Integrated Query (LINQ) para consultar datos de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="94dcc-103">Entity Framework Core uses Language Integrated Query (LINQ) to query data from the database.</span></span> <span data-ttu-id="94dcc-104">LINQ permite usar C# (o el lenguaje .NET que prefiera) para escribir consultas fuertemente tipadas basadas en el contexto derivado y las clases de entidad.</span><span class="sxs-lookup"><span data-stu-id="94dcc-104">LINQ allows you to use C# (or your .NET language of choice) to write strongly typed queries based on your derived context and entity classes.</span></span>

## <a name="the-life-of-a-query"></a><span data-ttu-id="94dcc-105">La duración de una consulta</span><span class="sxs-lookup"><span data-stu-id="94dcc-105">The life of a query</span></span>

<span data-ttu-id="94dcc-106">A continuación se muestra información general de alto nivel del proceso por el que pasa toda consulta.</span><span class="sxs-lookup"><span data-stu-id="94dcc-106">The following is a high level overview of the process each query goes through.</span></span>

1. <span data-ttu-id="94dcc-107">Entity Framework Core procesa la consulta LINQ para crear una representación que está lista para que el proveedor de base de datos la procese.</span><span class="sxs-lookup"><span data-stu-id="94dcc-107">The LINQ query is processed by Entity Framework Core to build a representation that is ready to be processed by the database provider</span></span>
   1. <span data-ttu-id="94dcc-108">El resultado se almacena en caché para que no sea necesario hacer este procesamiento cada vez que se ejecuta la consulta.</span><span class="sxs-lookup"><span data-stu-id="94dcc-108">The result is cached so that this processing does not need to be done every time the query is executed</span></span>
2. <span data-ttu-id="94dcc-109">El resultado se pasa al proveedor de base de datos.</span><span class="sxs-lookup"><span data-stu-id="94dcc-109">The result is passed to the database provider</span></span>
   1. <span data-ttu-id="94dcc-110">El proveedor de base de datos identifica qué partes de la consulta se pueden evaluar en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="94dcc-110">The database provider identifies which parts of the query can be evaluated in the database</span></span>
   2. <span data-ttu-id="94dcc-111">Estas partes de la consulta se traducen al lenguaje de la consulta específico para la base de datos (por ejemplo, SQL para una base de datos relacional).</span><span class="sxs-lookup"><span data-stu-id="94dcc-111">These parts of the query are translated to database specific query language (for example, SQL for a relational database)</span></span>
   3. <span data-ttu-id="94dcc-112">Una o varias consultas se envían a la base de datos y se devuelve el conjunto de resultados (los resultados son valores de la base de datos y no instancias de entidad).</span><span class="sxs-lookup"><span data-stu-id="94dcc-112">One or more queries are sent to the database and the result set returned (results are values from the database, not entity instances)</span></span>
3. <span data-ttu-id="94dcc-113">Para cada elemento del conjunto de resultados</span><span class="sxs-lookup"><span data-stu-id="94dcc-113">For each item in the result set</span></span>
   1. <span data-ttu-id="94dcc-114">Si se trata de una consulta con seguimiento, EF comprueba si los datos representan una entidad que ya existe en la herramienta de seguimiento de cambios para la instancia de contexto.</span><span class="sxs-lookup"><span data-stu-id="94dcc-114">If this is a tracking query, EF checks if the data represents an entity already in the change tracker for the context instance</span></span>
      * <span data-ttu-id="94dcc-115">Si es así, se devuelve la entidad existente.</span><span class="sxs-lookup"><span data-stu-id="94dcc-115">If so, the existing entity is returned</span></span>
      * <span data-ttu-id="94dcc-116">En caso contrario, se crea una entidad nueva, se configura el seguimiento de cambios y se devuelve la entidad nueva.</span><span class="sxs-lookup"><span data-stu-id="94dcc-116">If not, a new entity is created, change tracking is setup, and the new entity is returned</span></span>
   2. <span data-ttu-id="94dcc-117">Si se trata de una consulta sin seguimiento, EF comprueba si los datos representan una entidad que ya existe en el conjunto de resultados de esta consulta.</span><span class="sxs-lookup"><span data-stu-id="94dcc-117">If this is a no-tracking query, EF checks if the data represents an entity already in the result set for this query</span></span>
      * <span data-ttu-id="94dcc-118">Si es así, se devuelve la entidad existente <sup>(1)</sup>.</span><span class="sxs-lookup"><span data-stu-id="94dcc-118">If so, the existing entity is returned <sup>(1)</sup></span></span>
      * <span data-ttu-id="94dcc-119">En caso contrario, se crea y devuelve una entidad nueva.</span><span class="sxs-lookup"><span data-stu-id="94dcc-119">If not, a new entity is created and returned</span></span>

<span data-ttu-id="94dcc-120"><sup>(1)</sup> Las consultas sin seguimiento usan referencias parciales para llevar un seguimiento de las entidades que ya se devolvieron.</span><span class="sxs-lookup"><span data-stu-id="94dcc-120"><sup>(1)</sup> No tracking queries use weak references to keep track of entities that have already been returned.</span></span> <span data-ttu-id="94dcc-121">Si un resultado anterior con la misma identidad queda fuera del ámbito y se ejecuta la recolección de elementos no utilizados, puede obtener una instancia de entidad nueva.</span><span class="sxs-lookup"><span data-stu-id="94dcc-121">If a previous result with the same identity goes out of scope, and garbage collection runs, you may get a new entity instance.</span></span>

## <a name="when-queries-are-executed"></a><span data-ttu-id="94dcc-122">Cuándo se ejecutan las consultas</span><span class="sxs-lookup"><span data-stu-id="94dcc-122">When queries are executed</span></span>

<span data-ttu-id="94dcc-123">Cuando llama a los operadores LINQ, simplemente crea una representación de la consulta en memoria.</span><span class="sxs-lookup"><span data-stu-id="94dcc-123">When you call LINQ operators, you are simply building up an in-memory representation of the query.</span></span> <span data-ttu-id="94dcc-124">La consulta solo se envía a la base de datos cuando se usan los resultados.</span><span class="sxs-lookup"><span data-stu-id="94dcc-124">The query is only sent to the database when the results are consumed.</span></span>

<span data-ttu-id="94dcc-125">Las operaciones más comunes que generan que la consulta se envíe a la base de datos son:</span><span class="sxs-lookup"><span data-stu-id="94dcc-125">The most common operations that result in the query being sent to the database are:</span></span>
* <span data-ttu-id="94dcc-126">La iteración de los resultados en un bucle `for`</span><span class="sxs-lookup"><span data-stu-id="94dcc-126">Iterating the results in a `for` loop</span></span>
* <span data-ttu-id="94dcc-127">El uso de un operador como `ToList`, `ToArray`, `Single`, `Count`</span><span class="sxs-lookup"><span data-stu-id="94dcc-127">Using an operator such as `ToList`, `ToArray`, `Single`, `Count`</span></span>
* <span data-ttu-id="94dcc-128">El enlace de datos de los resultados de una consulta a una interfaz de usuario</span><span class="sxs-lookup"><span data-stu-id="94dcc-128">Databinding the results of a query to a UI</span></span>

> [!WARNING]  
> <span data-ttu-id="94dcc-129">**Valide siempre la entrada del usuario:** aunque EF Core protege contra los ataques por inyección de código SQL con el uso de parámetros y el escape de cadenas literales en consultas, no valida las entradas.</span><span class="sxs-lookup"><span data-stu-id="94dcc-129">**Always validate user input:** While EF Core protects against SQL injection attacks by using parameters and escaping literals in queries, it does not validate inputs.</span></span> <span data-ttu-id="94dcc-130">Se debe realizar una validación apropiada, según los requisitos de la aplicación, antes de que los valores de los orígenes que no son de confianza se usen en consultas LINQ, se asignen a las propiedades de una entidad o se pasen a otras API de EF Core.</span><span class="sxs-lookup"><span data-stu-id="94dcc-130">Appropriate validation, per the application's requirements, should be performed before values from untrusted sources are used in LINQ queries, assigned to entity properties, or passed to other EF Core APIs.</span></span> <span data-ttu-id="94dcc-131">Esto incluye cualquier intervención del usuario que se use para construir consultas de manera dinámica.</span><span class="sxs-lookup"><span data-stu-id="94dcc-131">This includes any user input used to dynamically construct queries.</span></span> <span data-ttu-id="94dcc-132">Incluso al usar LINQ, si acepta la intervención del usuario para crear expresiones, necesita garantizar que solo se pueden construir las expresiones previstas.</span><span class="sxs-lookup"><span data-stu-id="94dcc-132">Even when using LINQ, if you are accepting user input to build expressions, you need to make sure that only intended expressions can be constructed.</span></span>
