---
title: 'Consultas de seguimiento frente a consultas de no seguimiento: EF Core'
description: Información sobre las consultas de seguimiento y no seguimiento en Entity Framework Core
author: smitpatel
ms.date: 11/09/2020
uid: core/querying/tracking
ms.openlocfilehash: 1b3c1db702438390c0de4a2ad5d13e868a522b65
ms.sourcegitcommit: 032a1767d7a6e42052a005f660b80372c6521e7e
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 01/12/2021
ms.locfileid: "98128906"
---
# <a name="tracking-vs-no-tracking-queries"></a><span data-ttu-id="f8f65-103">Consultas de seguimiento frente a consultas de no seguimiento</span><span class="sxs-lookup"><span data-stu-id="f8f65-103">Tracking vs. No-Tracking Queries</span></span>

<span data-ttu-id="f8f65-104">El comportamiento de seguimiento controla si Entity Framework Core mantendrá información sobre una instancia de entidad en su herramienta de seguimiento de cambios.</span><span class="sxs-lookup"><span data-stu-id="f8f65-104">Tracking behavior controls if Entity Framework Core will keep information about an entity instance in its change tracker.</span></span> <span data-ttu-id="f8f65-105">Si se hace seguimiento de una entidad, cualquier cambio detectado en ella persistirá hasta la base de datos durante `SaveChanges()`.</span><span class="sxs-lookup"><span data-stu-id="f8f65-105">If an entity is tracked, any changes detected in the entity will be persisted to the database during `SaveChanges()`.</span></span> <span data-ttu-id="f8f65-106">EF Core también corregirá las propiedades de navegación entre las entidades de un resultado de consulta de seguimiento y las entidades que se encuentran en la herramienta de seguimiento de cambios.</span><span class="sxs-lookup"><span data-stu-id="f8f65-106">EF Core will also fix up navigation properties between the entities in a tracking query result and the entities that are in the change tracker.</span></span>

> [!NOTE]
> <span data-ttu-id="f8f65-107">No se realiza el seguimiento de los [tipos de entidad sin clave](xref:core/modeling/keyless-entity-types).</span><span class="sxs-lookup"><span data-stu-id="f8f65-107">[Keyless entity types](xref:core/modeling/keyless-entity-types) are never tracked.</span></span> <span data-ttu-id="f8f65-108">Siempre que en este artículo se mencionen los tipos de entidad, se refiere a aquellos con una clave definida.</span><span class="sxs-lookup"><span data-stu-id="f8f65-108">Wherever this article mentions entity types, it refers to entity types which have a key defined.</span></span>

> [!TIP]
> <span data-ttu-id="f8f65-109">Puede ver un [ejemplo](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Querying/Tracking) de este artículo en GitHub.</span><span class="sxs-lookup"><span data-stu-id="f8f65-109">You can view this article's [sample](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Querying/Tracking) on GitHub.</span></span>

## <a name="tracking-queries"></a><span data-ttu-id="f8f65-110">Consultas de seguimiento</span><span class="sxs-lookup"><span data-stu-id="f8f65-110">Tracking queries</span></span>

<span data-ttu-id="f8f65-111">De manera predeterminada, las consultas que devuelven tipos de entidad son consultas de seguimiento.</span><span class="sxs-lookup"><span data-stu-id="f8f65-111">By default, queries that return entity types are tracking.</span></span> <span data-ttu-id="f8f65-112">Esto significa que puede hacer cambios en esas instancias de entidad y que esos cambios se conservan mediante `SaveChanges()`.</span><span class="sxs-lookup"><span data-stu-id="f8f65-112">Which means you can make changes to those entity instances and have those changes persisted by `SaveChanges()`.</span></span> <span data-ttu-id="f8f65-113">En el ejemplo siguiente, se detectará el cambio en la clasificación de los blogs y persistirá hasta la base de datos durante `SaveChanges()`.</span><span class="sxs-lookup"><span data-stu-id="f8f65-113">In the following example, the change to the blogs rating will be detected and persisted to the database during `SaveChanges()`.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#Tracking)]

<span data-ttu-id="f8f65-114">Cuando los resultados se devuelven en una consulta de seguimiento, EF Core comprobará si la entidad ya está en el contexto.</span><span class="sxs-lookup"><span data-stu-id="f8f65-114">When the results are returned in a tracking query, EF Core will check if the entity is already in the context.</span></span> <span data-ttu-id="f8f65-115">Si EF Core encuentra una entidad existente, se devuelve la misma instancia.</span><span class="sxs-lookup"><span data-stu-id="f8f65-115">If EF Core finds an existing entity, then the same instance is returned.</span></span> <span data-ttu-id="f8f65-116">EF Core no sobrescribirá los valores actuales y originales de las propiedades de la entidad en la entrada con los valores de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="f8f65-116">EF Core won't overwrite current and original values of the entity's properties in the entry with the database values.</span></span> <span data-ttu-id="f8f65-117">Si no se encuentra la entidad en el contexto, EF Core creará una nueva instancia de la entidad y la asociará al contexto.</span><span class="sxs-lookup"><span data-stu-id="f8f65-117">If the entity isn't found in the context, then EF Core will create new entity instance and attach it to the context.</span></span> <span data-ttu-id="f8f65-118">Los resultados de la consulta no contienen ninguna entidad, que se agrega al contexto pero aún no se guarda en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="f8f65-118">Query results don't contain any entity, which is added to the context but not yet saved to the database.</span></span>

## <a name="no-tracking-queries"></a><span data-ttu-id="f8f65-119">Consultas de no seguimiento</span><span class="sxs-lookup"><span data-stu-id="f8f65-119">No-tracking queries</span></span>

<span data-ttu-id="f8f65-120">Las consultas de no seguimiento son útiles cuando los resultados se usan en un escenario de solo lectura.</span><span class="sxs-lookup"><span data-stu-id="f8f65-120">No tracking queries are useful when the results are used in a read-only scenario.</span></span> <span data-ttu-id="f8f65-121">Su ejecución es más rápida porque no es necesario configurar la información de seguimiento de cambios.</span><span class="sxs-lookup"><span data-stu-id="f8f65-121">They're quicker to execute because there's no need to set up the change tracking information.</span></span> <span data-ttu-id="f8f65-122">Si no necesita actualizar las entidades recuperadas de la base de datos, se debe usar una consulta de no seguimiento.</span><span class="sxs-lookup"><span data-stu-id="f8f65-122">If you don't need to update the entities retrieved from the database, then a no-tracking query should be used.</span></span> <span data-ttu-id="f8f65-123">Puede cambiar una consulta individual para que sea una consulta de no seguimiento.</span><span class="sxs-lookup"><span data-stu-id="f8f65-123">You can swap an individual query to be no-tracking.</span></span> <span data-ttu-id="f8f65-124">Una consulta de no seguimiento también proporcionará los resultados en función de lo que haya en la base de datos, sin tener en cuenta los cambios locales ni las entidades agregadas.</span><span class="sxs-lookup"><span data-stu-id="f8f65-124">No tracking query will also give you results based on what is in the database disregarding any local changes or added entities.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#NoTracking)]

<span data-ttu-id="f8f65-125">También puede cambiar el comportamiento de seguimiento predeterminado en el nivel de instancia de contexto:</span><span class="sxs-lookup"><span data-stu-id="f8f65-125">You can also change the default tracking behavior at the context instance level:</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#ContextDefaultTrackingBehavior)]

## <a name="identity-resolution"></a><span data-ttu-id="f8f65-126">Resolución de identidad</span><span class="sxs-lookup"><span data-stu-id="f8f65-126">Identity resolution</span></span>

<span data-ttu-id="f8f65-127">Dado que una consulta de seguimiento usa la herramienta de seguimiento de cambios, EF Core realizará la resolución de identidades en una consulta de este tipo.</span><span class="sxs-lookup"><span data-stu-id="f8f65-127">Since a tracking query uses the change tracker, EF Core will do identity resolution in a tracking query.</span></span> <span data-ttu-id="f8f65-128">Al materializar una entidad, EF Core devolverá la misma instancia de entidad de la herramienta de seguimiento de cambios si ya está en proceso de seguimiento.</span><span class="sxs-lookup"><span data-stu-id="f8f65-128">When materializing an entity, EF Core will return the same entity instance from the change tracker if it's already being tracked.</span></span> <span data-ttu-id="f8f65-129">Si el resultado contiene la misma entidad varias veces, se devuelve la misma instancia con cada repetición.</span><span class="sxs-lookup"><span data-stu-id="f8f65-129">If the result contains same entity multiple times, you get back same instance for each occurrence.</span></span> <span data-ttu-id="f8f65-130">Las consultas de no seguimiento no usan la herramienta de seguimiento de cambios y no realizan la resolución de identidades.</span><span class="sxs-lookup"><span data-stu-id="f8f65-130">No-tracking queries don't use the change tracker and don't do identity resolution.</span></span> <span data-ttu-id="f8f65-131">Así que, se devuelve una nueva instancia de la entidad incluso cuando la misma entidad está contenida en el resultado varias veces.</span><span class="sxs-lookup"><span data-stu-id="f8f65-131">So you get back new instance of entity even when the same entity is contained in the result multiple times.</span></span> <span data-ttu-id="f8f65-132">Este comportamiento era diferente en las versiones anteriores a EF Core 3.0; consulte las [versiones anteriores](#previous-versions).</span><span class="sxs-lookup"><span data-stu-id="f8f65-132">This behavior was different in versions before EF Core 3.0, see [previous versions](#previous-versions).</span></span>

<span data-ttu-id="f8f65-133">A partir de EF Core 5.0, puede combinar los dos comportamientos anteriores en la misma consulta.</span><span class="sxs-lookup"><span data-stu-id="f8f65-133">Starting with EF Core 5.0, you can combine both of the above behaviors in same query.</span></span> <span data-ttu-id="f8f65-134">Es decir, puede tener una consulta de no seguimiento, que llevará a cabo la resolución de identidades en los resultados.</span><span class="sxs-lookup"><span data-stu-id="f8f65-134">That is, you can have a no tracking query, which will do identity resolution in the results.</span></span> <span data-ttu-id="f8f65-135">Al igual que el operador consultable `AsNoTracking()`, hemos agregado otro operador `AsNoTrackingWithIdentityResolution()`.</span><span class="sxs-lookup"><span data-stu-id="f8f65-135">Just like `AsNoTracking()` queryable operator, we've added another operator `AsNoTrackingWithIdentityResolution()`.</span></span> <span data-ttu-id="f8f65-136">También hay una entrada asociada agregada en la enumeración <xref:Microsoft.EntityFrameworkCore.QueryTrackingBehavior>.</span><span class="sxs-lookup"><span data-stu-id="f8f65-136">There's also associated entry added in <xref:Microsoft.EntityFrameworkCore.QueryTrackingBehavior> enum.</span></span> <span data-ttu-id="f8f65-137">Cuando se configura la consulta para usar la resolución de identidad sin seguimiento, se usa un seguimiento de cambios independiente en segundo plano al generar los resultados de la consulta, por lo que cada instancia se materializa solo una vez.</span><span class="sxs-lookup"><span data-stu-id="f8f65-137">When you configure the query to use identity resolution with no tracking, we use a stand-alone change tracker in the background when generating query results so each instance is materialized only once.</span></span> <span data-ttu-id="f8f65-138">Dado que esta herramienta de seguimiento de cambios es diferente de la que se encuentra en el contexto, el contexto no realiza el seguimiento de los resultados.</span><span class="sxs-lookup"><span data-stu-id="f8f65-138">Since this change tracker is different from the one in the context, the results are not tracked by the context.</span></span> <span data-ttu-id="f8f65-139">Una vez que se completa la enumeración de la consulta, la herramienta de seguimiento de cambios queda fuera de ámbito y se recopilan los elementos no utilizados según sea necesario.</span><span class="sxs-lookup"><span data-stu-id="f8f65-139">After the query is enumerated fully, the change tracker goes out of scope and garbage collected as required.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#NoTrackingWithIdentityResolution)]

## <a name="tracking-and-custom-projections"></a><span data-ttu-id="f8f65-140">Seguimiento y proyecciones personalizadas</span><span class="sxs-lookup"><span data-stu-id="f8f65-140">Tracking and custom projections</span></span>

<span data-ttu-id="f8f65-141">Incluso si el tipo de resultado de la consulta no es un tipo de entidad, EF Core seguirá realizando el seguimiento de los tipos de entidad contenidos en el resultado de forma predeterminada.</span><span class="sxs-lookup"><span data-stu-id="f8f65-141">Even if the result type of the query isn't an entity type, EF Core will still track entity types contained in the result by default.</span></span> <span data-ttu-id="f8f65-142">En la consulta siguiente, que devuelve un tipo anónimo, se hará seguimiento de las instancias de `Blog` en el conjunto de resultados.</span><span class="sxs-lookup"><span data-stu-id="f8f65-142">In the following query, which returns an anonymous type, the instances of `Blog` in the result set will be tracked.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#CustomProjection1)]

<span data-ttu-id="f8f65-143">Si el conjunto de resultados contiene tipos de entidad que proceden de la composición LINQ, EF Core realizará un seguimiento de ellos.</span><span class="sxs-lookup"><span data-stu-id="f8f65-143">If the result set contains entity types coming out from LINQ composition, EF Core will track them.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#CustomProjection2)]

<span data-ttu-id="f8f65-144">Si el conjunto de resultados no contiene ningún tipo de entidad, no se realiza ningún seguimiento.</span><span class="sxs-lookup"><span data-stu-id="f8f65-144">If the result set doesn't contain any entity types, then no tracking is done.</span></span> <span data-ttu-id="f8f65-145">En la consulta siguiente, se devuelve un tipo anónimo con algunos de los valores de la entidad (pero sin instancias del tipo de entidad real).</span><span class="sxs-lookup"><span data-stu-id="f8f65-145">In the following query, we return an anonymous type with some of the values from the entity (but no instances of the actual entity type).</span></span> <span data-ttu-id="f8f65-146">No hay entidades con seguimiento que procedan de la consulta.</span><span class="sxs-lookup"><span data-stu-id="f8f65-146">There are no tracked entities coming out of the query.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#CustomProjection3)]

 <span data-ttu-id="f8f65-147">EF Core admite la evaluación del cliente en la proyección de nivel superior.</span><span class="sxs-lookup"><span data-stu-id="f8f65-147">EF Core supports doing client evaluation in the top-level projection.</span></span> <span data-ttu-id="f8f65-148">Si EF Core materializa una instancia de entidad para la evaluación del cliente, se realizará un seguimiento de esta.</span><span class="sxs-lookup"><span data-stu-id="f8f65-148">If EF Core materializes an entity instance for client evaluation, it will be tracked.</span></span> <span data-ttu-id="f8f65-149">Aquí, como se pasan entidades de `blog` al método cliente `StandardizeURL`, EF Core también realizará un seguimiento de las instancias del blog.</span><span class="sxs-lookup"><span data-stu-id="f8f65-149">Here, since we're passing `blog` entities to the client method `StandardizeURL`, EF Core will track the blog instances too.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#ClientProjection)]

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#ClientMethod)]

<span data-ttu-id="f8f65-150">EF Core no realiza un seguimiento de las instancias de entidad sin clave contenidas en el resultado.</span><span class="sxs-lookup"><span data-stu-id="f8f65-150">EF Core doesn't track the keyless entity instances contained in the result.</span></span> <span data-ttu-id="f8f65-151">Sin embargo, sí lo hace de todas las demás instancias de tipos de entidad con clave según las reglas anteriores.</span><span class="sxs-lookup"><span data-stu-id="f8f65-151">But EF Core tracks all the other instances of entity types with key according to rules above.</span></span>

<span data-ttu-id="f8f65-152">Algunas de las reglas anteriores funcionaban de forma diferente antes de EF Core 3.0.</span><span class="sxs-lookup"><span data-stu-id="f8f65-152">Some of the above rules worked differently before EF Core 3.0.</span></span> <span data-ttu-id="f8f65-153">Para más información, consulte las [versiones anteriores](#previous-versions).</span><span class="sxs-lookup"><span data-stu-id="f8f65-153">For more information, see [previous versions](#previous-versions).</span></span>

## <a name="previous-versions"></a><span data-ttu-id="f8f65-154">Versiones anteriores</span><span class="sxs-lookup"><span data-stu-id="f8f65-154">Previous versions</span></span>

<span data-ttu-id="f8f65-155">Antes de la versión 3.0, EF Core presentaba algunas diferencias en el modo en que se realizaba el seguimiento.</span><span class="sxs-lookup"><span data-stu-id="f8f65-155">Before version 3.0, EF Core had some differences in how tracking was done.</span></span> <span data-ttu-id="f8f65-156">Las diferencias destacables son las siguientes:</span><span class="sxs-lookup"><span data-stu-id="f8f65-156">Notable differences are as follows:</span></span>

- <span data-ttu-id="f8f65-157">Como se explica en la página [Evaluación de cliente frente a servidor](xref:core/querying/client-eval), EF Core admitía la evaluación de clientes admitidos en cualquier parte de la consulta anterior antes de la versión 3.0.</span><span class="sxs-lookup"><span data-stu-id="f8f65-157">As explained in [Client vs Server Evaluation](xref:core/querying/client-eval) page, EF Core supported client evaluation in any part of the query before version 3.0.</span></span> <span data-ttu-id="f8f65-158">La evaluación de clientes provocaba la materialización de entidades, las cuales no formaban parte del resultado.</span><span class="sxs-lookup"><span data-stu-id="f8f65-158">Client evaluation caused materialization of entities, which weren't part of the result.</span></span> <span data-ttu-id="f8f65-159">Por lo tanto, EF Core analizaba el resultado para detectar de qué realizar el seguimiento. Este diseño tenía algunas diferencias, como se indica a continuación:</span><span class="sxs-lookup"><span data-stu-id="f8f65-159">So EF Core analyzed the result to detect what to track. This design had certain differences as follows:</span></span>
  - <span data-ttu-id="f8f65-160">No se realizaba el seguimiento de la evaluación de clientes en la proyección, lo que provocaba la materialización pero no se devolvía la instancia de la entidad materializada.</span><span class="sxs-lookup"><span data-stu-id="f8f65-160">Client evaluation in the projection, which caused materialization but didn't return the materialized entity instance wasn't tracked.</span></span> <span data-ttu-id="f8f65-161">En el ejemplo siguiente no se realizaba un seguimiento de entidades `blog`.</span><span class="sxs-lookup"><span data-stu-id="f8f65-161">The following example didn't track `blog` entities.</span></span>
    [!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#ClientProjection)]

  - <span data-ttu-id="f8f65-162">En algunos casos, EF Core no realizaba un seguimiento de los objetos que procedían de la composición LINQ.</span><span class="sxs-lookup"><span data-stu-id="f8f65-162">EF Core didn't track the objects coming out of LINQ composition in certain cases.</span></span> <span data-ttu-id="f8f65-163">En el ejemplo siguiente no se realizaba un seguimiento de `Post`.</span><span class="sxs-lookup"><span data-stu-id="f8f65-163">The following example didn't track `Post`.</span></span>
    [!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#CustomProjection2)]

- <span data-ttu-id="f8f65-164">Siempre que los resultados de consulta contenían tipos de entidad sin clave, significaba que no se hacía un seguimiento de la consulta completa.</span><span class="sxs-lookup"><span data-stu-id="f8f65-164">Whenever query results contained keyless entity types, the whole query was made non-tracking.</span></span> <span data-ttu-id="f8f65-165">Esto quiere decir que tampoco se realizaba un seguimiento de los tipos de entidad con claves que estaban en el resultado.</span><span class="sxs-lookup"><span data-stu-id="f8f65-165">That means that entity types with keys, which are in result weren't being tracked either.</span></span>
- <span data-ttu-id="f8f65-166">EF Coreó realizaba la resolución de identidades en consultas de no seguimiento.</span><span class="sxs-lookup"><span data-stu-id="f8f65-166">EF Core did identity resolution in no-tracking query.</span></span> <span data-ttu-id="f8f65-167">Se usaban referencias débiles para mantener el seguimiento de entidades que ya se habían devuelto.</span><span class="sxs-lookup"><span data-stu-id="f8f65-167">It used weak references to keep track of entities that had already been returned.</span></span> <span data-ttu-id="f8f65-168">Por lo tanto, si un conjunto de resultados contenía la misma entidad varias veces, obtenía la misma instancia para cada caso.</span><span class="sxs-lookup"><span data-stu-id="f8f65-168">So if a result set contained the same entity multiples times, you would get the same instance for each occurrence.</span></span> <span data-ttu-id="f8f65-169">Sin embargo, si un resultado anterior con la misma identidad se salía del ámbito y generaba un elemento no utilizado, EF Core devolvía una nueva instancia.</span><span class="sxs-lookup"><span data-stu-id="f8f65-169">Though if a previous result with the same identity went out of scope and got garbage collected, EF Core returned a new instance.</span></span>
