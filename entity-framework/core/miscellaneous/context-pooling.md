---
title: Agrupación de DbContext
description: Agrupación de DbContext en Entity Framework Core
author: rick-anderson
ms.author: riande
ms.date: 9/19/2020
uid: core/miscellaneous/context-pooling
ms.openlocfilehash: fd5f53ff97a73895f0c4239439730dd8cb3ecc29
ms.sourcegitcommit: c0e6a00b64c2dcd8acdc0fe6d1b47703405cdf09
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 09/24/2020
ms.locfileid: "91215589"
---
# <a name="dbcontext-pooling"></a><span data-ttu-id="42dfb-103">Agrupación de DbContext</span><span class="sxs-lookup"><span data-stu-id="42dfb-103">DbContext pooling</span></span>

<span data-ttu-id="42dfb-104">`AddDbContextPool` habilita la agrupación de `DbContext` instancias de.</span><span class="sxs-lookup"><span data-stu-id="42dfb-104">`AddDbContextPool` enables pooling of `DbContext` instances.</span></span> <span data-ttu-id="42dfb-105">La agrupación de contexto puede aumentar el rendimiento en escenarios de gran escala, como servidores Web, mediante la reutilización de instancias de contexto, en lugar de crear nuevas instancias para cada solicitud.</span><span class="sxs-lookup"><span data-stu-id="42dfb-105">Context pooling can increase throughput in high-scale scenarios such as web servers by reusing context instances, rather than creating new instances for each request.</span></span>

<span data-ttu-id="42dfb-106">El patrón típico en una aplicación ASP.NET Core con EF Core implica registrar un tipo personalizado en <xref:Microsoft.EntityFrameworkCore.DbContext> el contenedor de [inserción de dependencias](/aspnet/core/fundamentals/dependency-injection) y obtener instancias de ese tipo a través de parámetros de constructor en controladores o Razor pages.</span><span class="sxs-lookup"><span data-stu-id="42dfb-106">The typical pattern in an ASP.NET Core app using EF Core involves registering a custom <xref:Microsoft.EntityFrameworkCore.DbContext> type into the [dependency injection](/aspnet/core/fundamentals/dependency-injection) container and obtaining instances of that type through constructor parameters in controllers or Razor Pages.</span></span> <span data-ttu-id="42dfb-107">Mediante la inserción de constructores, se crea una nueva instancia de contexto para cada solicitud.</span><span class="sxs-lookup"><span data-stu-id="42dfb-107">Using constructor injection, a new context instance is created for each request.</span></span>

<span data-ttu-id="42dfb-108"><xref:Microsoft.Extensions.DependencyInjection.EntityFrameworkServiceCollectionExtensions.AddDbContextPool%2A> habilita un grupo de instancias de contexto reutilizables.</span><span class="sxs-lookup"><span data-stu-id="42dfb-108"><xref:Microsoft.Extensions.DependencyInjection.EntityFrameworkServiceCollectionExtensions.AddDbContextPool%2A> enables a pool of reusable context instances.</span></span> <span data-ttu-id="42dfb-109">Para usar la agrupación de contexto, use el `AddDbContextPool` método en lugar de `AddDbContext` durante el registro del servicio:</span><span class="sxs-lookup"><span data-stu-id="42dfb-109">To use context pooling, use the `AddDbContextPool` method instead of `AddDbContext` during service registration:</span></span>

``` csharp
services.AddDbContextPool<BloggingContext>(
    options => options.UseSqlServer(connectionString));
```

<span data-ttu-id="42dfb-110">Cuando `AddDbContextPool` se usa, en el momento en que se solicita una instancia de contexto, EF comprueba primero si hay una instancia disponible en el grupo.</span><span class="sxs-lookup"><span data-stu-id="42dfb-110">When `AddDbContextPool` is used, at the time a context instance is requested, EF first checks if there is an instance available in the pool.</span></span> <span data-ttu-id="42dfb-111">Una vez que termina el procesamiento de la solicitud, se restablece cualquier estado en la instancia y la propia instancia se devuelve al grupo.</span><span class="sxs-lookup"><span data-stu-id="42dfb-111">Once the request processing finalizes, any state on the instance is reset and the instance is itself returned to the pool.</span></span>

<span data-ttu-id="42dfb-112">Esto es conceptualmente similar a la forma en que funciona la agrupación de conexiones en los proveedores de ADO.NET y tiene la ventaja de ahorrar parte del costo de inicialización de la instancia de contexto.</span><span class="sxs-lookup"><span data-stu-id="42dfb-112">This is conceptually similar to how connection pooling operates in ADO.NET providers and has the advantage of saving some of the cost of initialization of the context instance.</span></span>

<span data-ttu-id="42dfb-113">El `poolSize` parámetro de <xref:Microsoft.Extensions.DependencyInjection.EntityFrameworkServiceCollectionExtensions.AddDbContextPool%2A> establece el número máximo de instancias retenidas por el grupo.</span><span class="sxs-lookup"><span data-stu-id="42dfb-113">The `poolSize` parameter of <xref:Microsoft.Extensions.DependencyInjection.EntityFrameworkServiceCollectionExtensions.AddDbContextPool%2A> sets the maximum number of instances retained by the pool.</span></span> <span data-ttu-id="42dfb-114">Una vez que `poolSize` se supera, las nuevas instancias de contexto no se almacenan en caché y EF recurre al comportamiento de no agrupación de la creación de instancias a petición.</span><span class="sxs-lookup"><span data-stu-id="42dfb-114">Once `poolSize` is exceeded, new context instances are not cached and  EF falls back to the non-pooling behavior of creating instances on demand.</span></span>

## <a name="limitations"></a><span data-ttu-id="42dfb-115">Limitaciones</span><span class="sxs-lookup"><span data-stu-id="42dfb-115">Limitations</span></span>

<span data-ttu-id="42dfb-116">Se debe crear un perfiles de las aplicaciones y probarlas para mostrar que la inicialización del contexto supone un costo significativo.</span><span class="sxs-lookup"><span data-stu-id="42dfb-116">Apps should be profiled and tested to show that context initialization is a significant cost.</span></span>

<span data-ttu-id="42dfb-117">`AddDbContextPool` tiene algunas limitaciones en lo que se puede hacer en el `OnConfiguring` método del contexto.</span><span class="sxs-lookup"><span data-stu-id="42dfb-117">`AddDbContextPool` has a few limitations on what can be done in the `OnConfiguring` method of the context.</span></span>

> [!WARNING]  
> <span data-ttu-id="42dfb-118">Evite el uso de la agrupación de contexto en aplicaciones que mantienen el estado.</span><span class="sxs-lookup"><span data-stu-id="42dfb-118">Avoid using context pooling in apps that maintain state.</span></span> <span data-ttu-id="42dfb-119">Por ejemplo, los campos privados en el contexto que no se deberían compartir entre las solicitudes.</span><span class="sxs-lookup"><span data-stu-id="42dfb-119">For example, private fields in the context that shouldn't be shared across requests.</span></span> <span data-ttu-id="42dfb-120">EF Core solo restablece el estado que se conoce antes de agregar una instancia de contexto al grupo.</span><span class="sxs-lookup"><span data-stu-id="42dfb-120">EF Core only resets the state that it is aware of before adding a context instance to the pool.</span></span>

<span data-ttu-id="42dfb-121">La agrupación de contexto funciona mediante la reutilización de la misma instancia de contexto en todas las solicitudes.</span><span class="sxs-lookup"><span data-stu-id="42dfb-121">Context pooling works by reusing the same context instance across requests.</span></span> <span data-ttu-id="42dfb-122">Esto significa que se registra de forma eficaz como [Singleton](/aspnet/core/fundamentals/dependency-injection#service-lifetimes) en lo que se refiere a la propia instancia para que pueda persistir.</span><span class="sxs-lookup"><span data-stu-id="42dfb-122">This means that it's effectively registered as a [Singleton](/aspnet/core/fundamentals/dependency-injection#service-lifetimes) in terms of the instance itself so that it's able to persist.</span></span>

<span data-ttu-id="42dfb-123">La agrupación de contexto está pensada para escenarios en los que la configuración de contexto, que incluye los servicios resueltos, se fija entre solicitudes.</span><span class="sxs-lookup"><span data-stu-id="42dfb-123">Context pooling is intended for scenarios where the context configuration, which includes services resolved, is fixed between requests.</span></span> <span data-ttu-id="42dfb-124">En los casos en los que se requieren los servicios de [ámbito](/aspnet/core/fundamentals/dependency-injection#service-lifetimes) o es necesario cambiar la configuración, no utilice la agrupación.</span><span class="sxs-lookup"><span data-stu-id="42dfb-124">For cases where [Scoped](/aspnet/core/fundamentals/dependency-injection#service-lifetimes) services are required, or configuration needs to be changed, don't use pooling.</span></span> <span data-ttu-id="42dfb-125">La ganancia de rendimiento de la agrupación suele ser despreciable, excepto en escenarios muy optimizados.</span><span class="sxs-lookup"><span data-stu-id="42dfb-125">The performance gain from pooling is usually negligible except in highly optimized scenarios.</span></span>
