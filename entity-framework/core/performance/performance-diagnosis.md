---
title: 'Diagnóstico de rendimiento: EF Core'
description: Diagnóstico del rendimiento de Entity Framework Core e identificación de cuellos de botella
author: roji
ms.date: 12/1/2020
uid: core/performance/performance-diagnosis
ms.openlocfilehash: 85ffd1826723ad97bdcce517781f920c193e4286
ms.sourcegitcommit: 4798ab8d04c1fdbe6dd204d94d770fcbf309d09b
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 03/11/2021
ms.locfileid: "103023853"
---
# <a name="performance-diagnosis"></a><span data-ttu-id="7cdd6-103">Diagnóstico de rendimiento</span><span class="sxs-lookup"><span data-stu-id="7cdd6-103">Performance Diagnosis</span></span>

<span data-ttu-id="7cdd6-104">En esta sección se describen las formas de detectar problemas de rendimiento en la aplicación de EF y, una vez que se ha identificado una área problemática, cómo analizarlos más adelante para identificar el problema raíz.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-104">This section discusses ways for detecting performance issues in your EF application, and once a problematic area has been identified, how to further analyze them to identify the root problem.</span></span> <span data-ttu-id="7cdd6-105">Es importante diagnosticar e investigar detenidamente cualquier problema antes de pasar a cualquier conclusión y evitar que se asuma Dónde está la raíz del problema.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-105">It's important to carefully diagnose and investigate any problems before jumping to any conclusions, and to avoid assuming where the root of the issue is.</span></span>

## <a name="identifying-slow-database-commands-via-logging"></a><span data-ttu-id="7cdd6-106">Identificación de comandos lentos de base de datos mediante registro</span><span class="sxs-lookup"><span data-stu-id="7cdd6-106">Identifying slow database commands via logging</span></span>

<span data-ttu-id="7cdd6-107">Al final del día, EF prepara y ejecuta los comandos que se van a ejecutar en la base de datos. con bases de datos relacionales, esto significa ejecutar instrucciones SQL a través de la API de ADO.NET Database.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-107">At the end of the day, EF prepares and executes commands to be executed against your database; with relational database, that means executing SQL statements via the ADO.NET database API.</span></span> <span data-ttu-id="7cdd6-108">Si una determinada consulta está tardando demasiado tiempo (por ejemplo, porque falta un índice), esto se puede detectar detectando los registros de ejecución de comandos y observando cuánto tiempo tardan en completarse.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-108">If a certain query is taking too much time (e.g. because an index is missing), this can be seen discovered by inspecting command execution logs and observing how long they actually take.</span></span>

<span data-ttu-id="7cdd6-109">EF hace que sea muy fácil capturar los tiempos de ejecución de los comandos, a través de un [registro simple](xref:core/logging-events-diagnostics/simple-logging) o de [Microsoft. Extensions. Logging](xref:core/logging-events-diagnostics/extensions-logging):</span><span class="sxs-lookup"><span data-stu-id="7cdd6-109">EF makes it very easy to capture command execution times, via either [simple logging](xref:core/logging-events-diagnostics/simple-logging) or [Microsoft.Extensions.Logging](xref:core/logging-events-diagnostics/extensions-logging):</span></span>

### <a name="simple-logging"></a>[<span data-ttu-id="7cdd6-110">Registro sencillo</span><span class="sxs-lookup"><span data-stu-id="7cdd6-110">Simple logging</span></span>](#tab/simple-logging)

[!code-csharp[Main](../../../samples/core/Performance/BloggingContext.cs#SimpleLogging)]

### <a name="microsoftextensionslogging"></a>[<span data-ttu-id="7cdd6-111">Microsoft.Extensions.Logging</span><span class="sxs-lookup"><span data-stu-id="7cdd6-111">Microsoft.Extensions.Logging</span></span>](#tab/microsoft-extensions-logging)

[!code-csharp[Main](../../../samples/core/Performance/ExtensionsLoggingContext.cs#ExtensionsLogging)]

***

<span data-ttu-id="7cdd6-112">Cuando el nivel de registro se establece en `LogLevel.Information` , EF emite un mensaje de registro para cada ejecución del comando con el tiempo necesario:</span><span class="sxs-lookup"><span data-stu-id="7cdd6-112">When the logging level is set at `LogLevel.Information`, EF emits a log message for each command execution with the time taken:</span></span>

```log
info: 06/12/2020 09:12:36.117 RelationalEventId.CommandExecuted[20101] (Microsoft.EntityFrameworkCore.Database.Command)
      Executed DbCommand (4ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
      SELECT [b].[Id], [b].[Name]
      FROM [Blogs] AS [b]
      WHERE [b].[Name] = N'foo'
```

<span data-ttu-id="7cdd6-113">El comando anterior tardó 4 milisegundos.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-113">The above command took 4 milliseconds.</span></span> <span data-ttu-id="7cdd6-114">Si un comando determinado tarda más de lo esperado, ha encontrado una posible causa para un problema de rendimiento y ahora se puede centrar en él para comprender por qué se ejecuta lentamente.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-114">If a certain command takes more than expected, you've found a possible culprit for a performance issue, and can now focus on it to understand why it's running slowly.</span></span> <span data-ttu-id="7cdd6-115">El registro de comandos también puede revelar casos en los que se están realizando interconexións de base de datos inesperadas. Esto se mostraría como varios comandos en los que solo se esperaba uno.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-115">Command logging can also reveal cases where unexpected database roundtrips are being made; this would show up as multiple commands where only one is expected.</span></span>

> [!WARNING]
> <span data-ttu-id="7cdd6-116">Mantener el registro de la ejecución de comandos habilitado en el entorno de producción suele ser una buena idea.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-116">Leaving command execution logging enabled in your production environment is usually a bad idea.</span></span> <span data-ttu-id="7cdd6-117">El registro reduce la velocidad de la aplicación y puede crear rápidamente archivos de registro enormes que pueden llenar el disco del servidor.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-117">The logging itself slows down your application, and may quickly create huge log files which can fill up your server's disk.</span></span> <span data-ttu-id="7cdd6-118">Se recomienda mantener solo el inicio de sesión durante un breve intervalo de tiempo para recopilar datos y supervisar cuidadosamente la aplicación, o bien para capturar los datos de registro en un sistema de preproducción.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-118">It's recommended to only keep logging on for a short interval of time to gather data - while carefully monitoring your application - or to capture logging data on a pre-production system.</span></span>

## <a name="correlating-database-commands-to-linq-queries"></a><span data-ttu-id="7cdd6-119">Correlacionar comandos de base de datos en consultas LINQ</span><span class="sxs-lookup"><span data-stu-id="7cdd6-119">Correlating database commands to LINQ queries</span></span>

<span data-ttu-id="7cdd6-120">Un problema con el registro de la ejecución de comandos es que a veces es difícil correlacionar las consultas SQL y las consultas LINQ: los comandos SQL que ejecuta EF pueden ser muy diferentes de las consultas LINQ desde las que se generaron.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-120">One problem with command execution logging is that it's sometimes difficult to correlate SQL queries and LINQ queries: the SQL commands executed by EF can look very different from the LINQ queries from which they were generated.</span></span> <span data-ttu-id="7cdd6-121">Para ayudar a solucionar este problema, puede que desee usar la característica de [etiquetas de consulta](xref:core/querying/tags) de EF, que permite insertar un pequeño comentario de identificación en la consulta SQL:</span><span class="sxs-lookup"><span data-stu-id="7cdd6-121">To help with this difficulty, you may want to use EF's [query tags](xref:core/querying/tags) feature, which allows you to inject a small, identifying comment into the SQL query:</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tags/Program.cs#BasicQueryTag)]

<span data-ttu-id="7cdd6-122">La etiqueta se muestra en los registros:</span><span class="sxs-lookup"><span data-stu-id="7cdd6-122">The tag shows up in the logs:</span></span>

```sql
-- This is my spatial query!

SELECT TOP(@__p_1) [p].[Id], [p].[Location]
FROM [People] AS [p]
ORDER BY [p].[Location].STDistance(@__myLocation_0) DESC
```

<span data-ttu-id="7cdd6-123">A menudo merece la pena etiquetar las consultas más importantes de una aplicación de esta manera, para que los registros de ejecución de comandos sean más inmediatos y legibles.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-123">It's often worth tagging the major queries of an application in this way, to make the command execution logs more immediately readable.</span></span>

## <a name="other-interfaces-for-capturing-performance-data"></a><span data-ttu-id="7cdd6-124">Otras interfaces para capturar datos de rendimiento</span><span class="sxs-lookup"><span data-stu-id="7cdd6-124">Other interfaces for capturing performance data</span></span>

<span data-ttu-id="7cdd6-125">Hay varias alternativas a la característica de registro de EF para capturar los tiempos de ejecución del comando, lo que puede ser más eficaz.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-125">There are various alternatives to EF's logging feature for capturing command execution times, which may be more powerful.</span></span> <span data-ttu-id="7cdd6-126">Las bases de datos suelen incluir sus propias herramientas de análisis de rendimiento y seguimiento, que normalmente proporcionan información específica de la base de datos mucho más enriquecida, más allá de los tiempos de ejecución simples. la configuración, las capacidades y el uso reales varían considerablemente entre las bases de datos.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-126">Databases typically come with their own tracing and performance analysis tools, which usually provide much richer, database-specific information beyond simple execution times; the actual setup, capabilities and usage vary considerably across databases.</span></span>

<span data-ttu-id="7cdd6-127">Por ejemplo, [SQL Server Management Studio](/sql/ssms/download-sql-server-management-studio-ssms) es un cliente eficaz que puede conectarse a su instancia de SQL Server y proporcionar información valiosa sobre el rendimiento y la administración.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-127">For example, [SQL Server Management Studio](/sql/ssms/download-sql-server-management-studio-ssms) is a powerful client that can connect to your SQL Server  instance and provide valuable management and performance information.</span></span> <span data-ttu-id="7cdd6-128">Queda fuera del ámbito de esta sección entrar en los detalles, pero dos funciones que merece la pena mencionar son el [monitor de actividad](/sql/relational-databases/performance-monitor/open-activity-monitor-sql-server-management-studio), que proporciona un panel activo de la actividad del servidor (incluidas las consultas más costosas) y la característica [eventos extendidos (XEvent)](/sql/relational-databases/extended-events/quick-start-extended-events-in-sql-server) , que permite definir sesiones de captura de datos arbitrarias que se pueden adaptar a sus necesidades exactas.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-128">It's beyond the scope of this section to go into the details, but two capabilities worth mentioning are the [Activity Monitor](/sql/relational-databases/performance-monitor/open-activity-monitor-sql-server-management-studio), which provides a live dashboard of server activity (including the most expensive queries), and the [Extended Events (XEvent)](/sql/relational-databases/extended-events/quick-start-extended-events-in-sql-server) feature, which allows defining arbitrary data capture sessions which can be tailored to your exact needs.</span></span> <span data-ttu-id="7cdd6-129">[La documentación SQL Server sobre supervisión](/sql/relational-databases/performance/monitor-and-tune-for-performance) proporciona más información sobre estas características, así como otras.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-129">[The SQL Server documentation on monitoring](/sql/relational-databases/performance/monitor-and-tune-for-performance) provides more information on these features, as well as others.</span></span>

<span data-ttu-id="7cdd6-130">Otro enfoque para capturar datos de rendimiento consiste en recopilar información emitida automáticamente por EF o el controlador de base de datos a través de la `DiagnosticSource` interfaz y, a continuación, analizar los datos o mostrarlos en un panel.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-130">Another approach for capturing performance data is to collect information automatically emitted by either EF or the database driver via the `DiagnosticSource` interface, and then analyze that data or display it on a dashboard.</span></span> <span data-ttu-id="7cdd6-131">Si usa Azure, [aplicación de Azure Insights](https://docs.microsoft.com/azure/azure-monitor/learn/tutorial-performance) proporciona una excelente supervisión de forma rápida, integrando el rendimiento de la base de datos y los tiempos de ejecución de las consultas en el análisis de la rapidez con que se atienden las solicitudes Web.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-131">If you are using Azure, then [Azure Application Insights](https://docs.microsoft.com/azure/azure-monitor/learn/tutorial-performance) provides such powerful monitoring out of the box, integrating database performance and query execution times in the analysis of how quickly your web requests are being served.</span></span> <span data-ttu-id="7cdd6-132">Puede encontrar más información sobre esto en el [tutorial de rendimiento de Application Insights](/azure/azure-monitor/learn/tutorial-performance)y en la [Página de Azure SQL Analytics](/azure/azure-monitor/insights/azure-sql).</span><span class="sxs-lookup"><span data-stu-id="7cdd6-132">More information on this is available in the [Application Insights performance tutorial](/azure/azure-monitor/learn/tutorial-performance), and in the [Azure SQL analytics page](/azure/azure-monitor/insights/azure-sql).</span></span>

## <a name="inspecting-query-execution-plans"></a><span data-ttu-id="7cdd6-133">Inspeccionar planes de ejecución de consultas</span><span class="sxs-lookup"><span data-stu-id="7cdd6-133">Inspecting query execution plans</span></span>

<span data-ttu-id="7cdd6-134">Una vez que haya finalizado una consulta problemática que requiere optimización, el paso siguiente suele analizar el plan de *ejecución* de la consulta.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-134">Once you've pinpointed a problematic query that requires optimization, the next step is usually analyzing the query's *execution plan*.</span></span> <span data-ttu-id="7cdd6-135">Cuando las bases de datos reciben una instrucción SQL, normalmente producen un plan del modo en que se va a ejecutar el plan; en ocasiones, esto requiere la toma de decisiones complicada en función de los índices que se han definido, la cantidad de datos que hay en las tablas, etc. (casualmente, el propio plan normalmente se debe almacenar en caché en el servidor para obtener un rendimiento óptimo).</span><span class="sxs-lookup"><span data-stu-id="7cdd6-135">When databases receive a SQL statement, they typically produce a plan of how that plan is to be executed; this sometimes requires complicated decision-making based on which indexes have been defined, how much data exists in tables, etc. (incidentally, the plan itself should usually be cached at the server for optimal performance).</span></span> <span data-ttu-id="7cdd6-136">Las bases de datos relacionales proporcionan normalmente una manera para que los usuarios vean el plan de consulta, junto con el costo calculado para distintas partes de la consulta. Esto es muy útil para mejorar las consultas.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-136">Relational databases typically provide a way for users to see the query plan, along with calculated costing for different parts of the query; this is invaluable for improving your queries.</span></span>

<span data-ttu-id="7cdd6-137">Para empezar a trabajar en SQL Server, consulte la documentación sobre los [planes de ejecución de consultas](/sql/relational-databases/performance/execution-plans).</span><span class="sxs-lookup"><span data-stu-id="7cdd6-137">To get started on SQL Server, see the documentation on [query execution plans](/sql/relational-databases/performance/execution-plans).</span></span> <span data-ttu-id="7cdd6-138">El flujo de trabajo de análisis típico sería usar [SQL Server Management Studio](/sql/relational-databases/performance/display-an-actual-execution-plan), pegar el SQL de una consulta lenta identificada mediante uno de los medios anteriores y [generar un plan de ejecución gráfico](/sql/relational-databases/performance/display-an-actual-execution-plan):</span><span class="sxs-lookup"><span data-stu-id="7cdd6-138">The typical analysis workflow would be to use [SQL Server Management Studio](/sql/relational-databases/performance/display-an-actual-execution-plan), pasting the SQL of a slow query identified via one of the means above, and [producing a graphical execution plan](/sql/relational-databases/performance/display-an-actual-execution-plan):</span></span>

![Mostrar un plan de ejecución de SQL Server](_static/actualexecplan.png)

<span data-ttu-id="7cdd6-140">Aunque los planes de ejecución pueden parecer complicados al principio, merece la pena dedicar algo de tiempo a familiarizarse con ellos.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-140">While execution plans may seem complicated at first, it's worth spending a bit of time getting familiar with them.</span></span> <span data-ttu-id="7cdd6-141">Es especialmente importante tener en cuenta los costos asociados a cada nodo del plan y para identificar cómo se usan (o no) los índices en los distintos nodos.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-141">It's particularly important to note the costs associated with each node of the plan, and to identify how indexes are used (or not) in the various nodes.</span></span>

<span data-ttu-id="7cdd6-142">Aunque la información anterior es específica de SQL Server, otras bases de datos normalmente proporcionan el mismo tipo de herramientas con una visualización similar.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-142">While the above information is specific to SQL Server, other databases typically provide the same kind of tools with similar visualization.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="7cdd6-143">A veces, las bases de datos generan distintos planes de consulta en función de los datos reales de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-143">Databases sometimes generate different query plans depending on actual data in the database.</span></span> <span data-ttu-id="7cdd6-144">Por ejemplo, si una tabla contiene solo unas pocas filas, una base de datos puede optar por no utilizar un índice en esa tabla, pero para realizar un recorrido de tabla completo en su lugar.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-144">For example, if a table contains only a few rows, a database may choose not to use an index on that table, but to perform a full table scan instead.</span></span> <span data-ttu-id="7cdd6-145">Si analiza los planes de consulta en una base de datos de prueba, asegúrese siempre de que contenga datos similares a los del sistema de producción.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-145">If analyzing query plans on a test database, always make sure it contains data that is similar to your production system.</span></span>

## <a name="event-counters"></a><span data-ttu-id="7cdd6-146">Contadores de eventos</span><span class="sxs-lookup"><span data-stu-id="7cdd6-146">Event counters</span></span>

<span data-ttu-id="7cdd6-147">Las secciones anteriores se centraban en cómo obtener información sobre los comandos y cómo se ejecutan estos comandos en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-147">The above sections focused on how to get information about your commands, and how these commands are executed in the database.</span></span> <span data-ttu-id="7cdd6-148">Además, EF expone un conjunto de *contadores de eventos* que proporcionan información más detallada sobre lo que está ocurriendo en el propio EF y cómo lo usa la aplicación.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-148">In addition to that, EF exposes a set of *event counters* which provide more lower-level information on what's happening inside EF itself, and how your application is using it.</span></span> <span data-ttu-id="7cdd6-149">Estos contadores pueden ser muy útiles para diagnosticar problemas de rendimiento y anomalías de rendimiento específicos, como los [problemas de almacenamiento en caché](xref:core/performance/advanced-performance-topics#dynamically-constructed-queries) de las consultas que causan una recompilación constante, pérdidas de DbContext desechadas y otras.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-149">These counters can be very useful for diagnosing specific performance issues and performance anomalies, such as [query caching issues](xref:core/performance/advanced-performance-topics#dynamically-constructed-queries) which cause constant recompilation, undisposed DbContext leaks, and others.</span></span>

<span data-ttu-id="7cdd6-150">Para obtener más información, consulte la página dedicada en los [contadores de eventos de EF](xref:core/logging-events-diagnostics/event-counters) .</span><span class="sxs-lookup"><span data-stu-id="7cdd6-150">See the dedicated page on [EF's event counters](xref:core/logging-events-diagnostics/event-counters) for more information.</span></span>

## <a name="benchmarking-with-ef-core"></a><span data-ttu-id="7cdd6-151">Pruebas comparativas con EF Core</span><span class="sxs-lookup"><span data-stu-id="7cdd6-151">Benchmarking with EF Core</span></span>

<span data-ttu-id="7cdd6-152">Al final del día, a veces es necesario saber si una forma determinada de escribir o ejecutar una consulta es más rápida que otra.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-152">At the end of the day, you sometimes need to know whether a particular way of writing or executing a query is faster than another.</span></span> <span data-ttu-id="7cdd6-153">Es importante no asumir ni especular la respuesta, y es muy fácil reunir una prueba comparativa rápida para obtener la respuesta.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-153">It's important to never assume or speculate the answer, and it's extremely easy to put together a quick benchmark to get the answer.</span></span> <span data-ttu-id="7cdd6-154">Al escribir las pruebas comparativas, se recomienda encarecidamente usar la biblioteca [BenchmarkDotNet](https://benchmarkdotnet.org/index.html) conocida, que controla muchos problemas que los usuarios encuentran al intentar escribir sus propias pruebas comparativas: ¿ha realizado algunas iteraciones de preparación?</span><span class="sxs-lookup"><span data-stu-id="7cdd6-154">When writing benchmarks, it's strongly recommended to use the well-known [BenchmarkDotNet](https://benchmarkdotnet.org/index.html) library, which handles many pitfalls users encounter when trying to write their own benchmarks: have you performed some warmup iterations?</span></span> <span data-ttu-id="7cdd6-155">¿Cuántas iteraciones ejecuta realmente la prueba comparativa y por qué?</span><span class="sxs-lookup"><span data-stu-id="7cdd6-155">How many iterations does your benchmark actually run, and why?</span></span> <span data-ttu-id="7cdd6-156">Echemos un vistazo a lo que tiene un banco de pruebas con EF Core.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-156">Let's take a look at what a benchmark with EF Core looks like.</span></span>

> [!TIP]
> <span data-ttu-id="7cdd6-157">El proyecto de prueba comparativa completa para el origen siguiente está disponible [aquí](https://github.com/dotnet/EntityFramework.Docs/tree/main/samples/core/Benchmarks/AverageBlogRanking.cs).</span><span class="sxs-lookup"><span data-stu-id="7cdd6-157">The full benchmark project for the source below is available [here](https://github.com/dotnet/EntityFramework.Docs/tree/main/samples/core/Benchmarks/AverageBlogRanking.cs).</span></span> <span data-ttu-id="7cdd6-158">Se recomienda copiarla y usarla como plantilla para sus propias pruebas comparativas.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-158">You are encouraged to copy it and use it as a template for your own benchmarks.</span></span>

<span data-ttu-id="7cdd6-159">Como escenario de pruebas comparativas simples, vamos a comparar los siguientes métodos diferentes para calcular el promedio de clasificación de todos los blogs de nuestra base de datos:</span><span class="sxs-lookup"><span data-stu-id="7cdd6-159">As a simple benchmark scenario, let's compare the following different methods of calculating the average ranking of all Blogs in our database:</span></span>

* <span data-ttu-id="7cdd6-160">Cargar todas las entidades, sumar sus clasificaciones individuales y calcular el promedio.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-160">Load all entities, sum up their individual rankings, and calculate the average.</span></span>
* <span data-ttu-id="7cdd6-161">Igual que antes, use solo una consulta sin seguimiento.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-161">The same as above, only use a non-tracking query.</span></span> <span data-ttu-id="7cdd6-162">Esto debería ser más rápido, ya que no se realiza la resolución de identidades y las entidades no son instantáneas para los fines del seguimiento de cambios.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-162">This should be faster, since identity resolution isn't performed, and the entities aren't snapshotted for the purposes of change tracking.</span></span>
* <span data-ttu-id="7cdd6-163">Evite la carga de todas las instancias de la entidad de blog, ya que solo tiene que proyectar la clasificación.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-163">Avoid loading the entire Blog entity instances at all, by projecting out the ranking only.</span></span> <span data-ttu-id="7cdd6-164">Nos evita transferir las demás columnas innecesarias del tipo de entidad de blog.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-164">The saves us from transferring the other, unneeded columns of the Blog entity type.</span></span>
* <span data-ttu-id="7cdd6-165">Calcule el promedio en la base de datos haciéndolo parte de la consulta.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-165">Calculate the average in the database by making it part of the query.</span></span> <span data-ttu-id="7cdd6-166">Esta es la forma más rápida, ya que todo se calcula en la base de datos y solo el resultado se transfiere de nuevo al cliente.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-166">This should be the fastest way, since everything is calculated in the database and only the result is transferred back to the client.</span></span>

<span data-ttu-id="7cdd6-167">Con BenchmarkDotNet, se escribe el código que se va a comparar como un método simple, al igual que una prueba unitaria-y BenchmarkDotNet ejecuta automáticamente cada método para un número suficiente de iteraciones, lo que mide de forma confiable cuánto tiempo tarda y cuánta memoria se asigna.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-167">With BenchmarkDotNet, you write the code to be benchmarked as a simple method - just like a unit test - and BenchmarkDotNet automatically runs each method for sufficient number of iterations, reliably measuring how long it takes and how much memory is allocated.</span></span> <span data-ttu-id="7cdd6-168">Este es el método diferente ([el código de prueba comparativa completa se puede ver aquí](https://github.com/dotnet/EntityFramework.Docs/tree/main/samples/core/Benchmarks/AverageBlogRanking.cs)):</span><span class="sxs-lookup"><span data-stu-id="7cdd6-168">Here are the different method ([the full benchmark code can be seen here](https://github.com/dotnet/EntityFramework.Docs/tree/main/samples/core/Benchmarks/AverageBlogRanking.cs)):</span></span>

### <a name="load-entities"></a>[<span data-ttu-id="7cdd6-169">Cargar entidades</span><span class="sxs-lookup"><span data-stu-id="7cdd6-169">Load entities</span></span>](#tab/load-entities)

[!code-csharp[Main](../../../samples/core/Benchmarks/AverageBlogRanking.cs?name=LoadEntities)]

### <a name="load-entities-no-tracking"></a>[<span data-ttu-id="7cdd6-170">Cargar entidades, sin seguimiento</span><span class="sxs-lookup"><span data-stu-id="7cdd6-170">Load entities, no tracking</span></span>](#tab/load-entities-no-tracking)

[!code-csharp[Main](../../../samples/core/Benchmarks/AverageBlogRanking.cs?name=LoadEntitiesNoTracking)]

### <a name="project-only-ranking"></a>[<span data-ttu-id="7cdd6-171">Clasificación solo del proyecto</span><span class="sxs-lookup"><span data-stu-id="7cdd6-171">Project only ranking</span></span>](#tab/project-only-ranking)

[!code-csharp[Main](../../../samples/core/Benchmarks/AverageBlogRanking.cs?name=ProjectOnlyRanking)]

### <a name="calculate-in-database"></a>[<span data-ttu-id="7cdd6-172">Calcular en la base de datos</span><span class="sxs-lookup"><span data-stu-id="7cdd6-172">Calculate in database</span></span>](#tab/calculate-in-database)

[!code-csharp[Main](../../../samples/core/Benchmarks/AverageBlogRanking.cs?name=CalculateInDatabase)]

***

<span data-ttu-id="7cdd6-173">Los resultados se muestran a continuación, como se imprime en BenchmarkDotNet:</span><span class="sxs-lookup"><span data-stu-id="7cdd6-173">The results are below, as printed by BenchmarkDotNet:</span></span>

|                 <span data-ttu-id="7cdd6-174">Método</span><span class="sxs-lookup"><span data-stu-id="7cdd6-174">Method</span></span> |       <span data-ttu-id="7cdd6-175">Media</span><span class="sxs-lookup"><span data-stu-id="7cdd6-175">Mean</span></span> |    <span data-ttu-id="7cdd6-176">Error</span><span class="sxs-lookup"><span data-stu-id="7cdd6-176">Error</span></span> |   <span data-ttu-id="7cdd6-177">StdDev</span><span class="sxs-lookup"><span data-stu-id="7cdd6-177">StdDev</span></span> |     <span data-ttu-id="7cdd6-178">Mediana</span><span class="sxs-lookup"><span data-stu-id="7cdd6-178">Median</span></span> | <span data-ttu-id="7cdd6-179">Proporción</span><span class="sxs-lookup"><span data-stu-id="7cdd6-179">Ratio</span></span> | <span data-ttu-id="7cdd6-180">RatioSD</span><span class="sxs-lookup"><span data-stu-id="7cdd6-180">RatioSD</span></span> |    <span data-ttu-id="7cdd6-181">Gen. 0</span><span class="sxs-lookup"><span data-stu-id="7cdd6-181">Gen 0</span></span> |   <span data-ttu-id="7cdd6-182">Gen. 1</span><span class="sxs-lookup"><span data-stu-id="7cdd6-182">Gen 1</span></span> | <span data-ttu-id="7cdd6-183">Gen. 2</span><span class="sxs-lookup"><span data-stu-id="7cdd6-183">Gen 2</span></span> |  <span data-ttu-id="7cdd6-184">Allocated</span><span class="sxs-lookup"><span data-stu-id="7cdd6-184">Allocated</span></span> |
|----------------------- |-----------:|---------:|---------:|-----------:|------:|--------:|---------:|--------:|------:|-----------:|
|           <span data-ttu-id="7cdd6-185">LoadEntities</span><span class="sxs-lookup"><span data-stu-id="7cdd6-185">LoadEntities</span></span> | <span data-ttu-id="7cdd6-186">2.860,4 EE. UU.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-186">2,860.4 us</span></span> | <span data-ttu-id="7cdd6-187">54,31 EE. UU.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-187">54.31 us</span></span> | <span data-ttu-id="7cdd6-188">93,68 EE. UU.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-188">93.68 us</span></span> | <span data-ttu-id="7cdd6-189">2.844,5 EE. UU.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-189">2,844.5 us</span></span> |  <span data-ttu-id="7cdd6-190">4.55</span><span class="sxs-lookup"><span data-stu-id="7cdd6-190">4.55</span></span> |    <span data-ttu-id="7cdd6-191">0,33</span><span class="sxs-lookup"><span data-stu-id="7cdd6-191">0.33</span></span> | <span data-ttu-id="7cdd6-192">210,9375</span><span class="sxs-lookup"><span data-stu-id="7cdd6-192">210.9375</span></span> | <span data-ttu-id="7cdd6-193">70,3125</span><span class="sxs-lookup"><span data-stu-id="7cdd6-193">70.3125</span></span> |     - | <span data-ttu-id="7cdd6-194">1309,56 KB</span><span class="sxs-lookup"><span data-stu-id="7cdd6-194">1309.56 KB</span></span> |
| <span data-ttu-id="7cdd6-195">LoadEntitiesNoTracking</span><span class="sxs-lookup"><span data-stu-id="7cdd6-195">LoadEntitiesNoTracking</span></span> | <span data-ttu-id="7cdd6-196">1.353,0 EE. UU.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-196">1,353.0 us</span></span> | <span data-ttu-id="7cdd6-197">21,26 EE. UU.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-197">21.26 us</span></span> | <span data-ttu-id="7cdd6-198">18,85 EE. UU.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-198">18.85 us</span></span> | <span data-ttu-id="7cdd6-199">1.355,6 EE. UU.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-199">1,355.6 us</span></span> |  <span data-ttu-id="7cdd6-200">2.10</span><span class="sxs-lookup"><span data-stu-id="7cdd6-200">2.10</span></span> |    <span data-ttu-id="7cdd6-201">0,14</span><span class="sxs-lookup"><span data-stu-id="7cdd6-201">0.14</span></span> |  <span data-ttu-id="7cdd6-202">87,8906</span><span class="sxs-lookup"><span data-stu-id="7cdd6-202">87.8906</span></span> |  <span data-ttu-id="7cdd6-203">3,9063</span><span class="sxs-lookup"><span data-stu-id="7cdd6-203">3.9063</span></span> |     - |  <span data-ttu-id="7cdd6-204">540,09 KB</span><span class="sxs-lookup"><span data-stu-id="7cdd6-204">540.09 KB</span></span> |
|     <span data-ttu-id="7cdd6-205">ProjectOnlyRanking</span><span class="sxs-lookup"><span data-stu-id="7cdd6-205">ProjectOnlyRanking</span></span> |   <span data-ttu-id="7cdd6-206">910,9 EE. UU.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-206">910.9 us</span></span> | <span data-ttu-id="7cdd6-207">20,91 EE. UU.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-207">20.91 us</span></span> | <span data-ttu-id="7cdd6-208">61,65 EE. UU.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-208">61.65 us</span></span> |   <span data-ttu-id="7cdd6-209">892,9 EE. UU.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-209">892.9 us</span></span> |  <span data-ttu-id="7cdd6-210">1,46</span><span class="sxs-lookup"><span data-stu-id="7cdd6-210">1.46</span></span> |    <span data-ttu-id="7cdd6-211">0,14</span><span class="sxs-lookup"><span data-stu-id="7cdd6-211">0.14</span></span> |  <span data-ttu-id="7cdd6-212">41,0156</span><span class="sxs-lookup"><span data-stu-id="7cdd6-212">41.0156</span></span> |  <span data-ttu-id="7cdd6-213">0,9766</span><span class="sxs-lookup"><span data-stu-id="7cdd6-213">0.9766</span></span> |     - |  <span data-ttu-id="7cdd6-214">252,08 KB</span><span class="sxs-lookup"><span data-stu-id="7cdd6-214">252.08 KB</span></span> |
|    <span data-ttu-id="7cdd6-215">CalculateInDatabase</span><span class="sxs-lookup"><span data-stu-id="7cdd6-215">CalculateInDatabase</span></span> |   <span data-ttu-id="7cdd6-216">627,1 EE. UU.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-216">627.1 us</span></span> | <span data-ttu-id="7cdd6-217">14,58 EE. UU.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-217">14.58 us</span></span> | <span data-ttu-id="7cdd6-218">42,54 EE. UU.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-218">42.54 us</span></span> |   <span data-ttu-id="7cdd6-219">626,4 EE. UU.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-219">626.4 us</span></span> |  <span data-ttu-id="7cdd6-220">1.00</span><span class="sxs-lookup"><span data-stu-id="7cdd6-220">1.00</span></span> |    <span data-ttu-id="7cdd6-221">0.00</span><span class="sxs-lookup"><span data-stu-id="7cdd6-221">0.00</span></span> |   <span data-ttu-id="7cdd6-222">4,8828</span><span class="sxs-lookup"><span data-stu-id="7cdd6-222">4.8828</span></span> |       - |     - |   <span data-ttu-id="7cdd6-223">33,27 KB</span><span class="sxs-lookup"><span data-stu-id="7cdd6-223">33.27 KB</span></span> |

> [!NOTE]
> <span data-ttu-id="7cdd6-224">Como los métodos crean una instancia y disposean el contexto dentro del método, estas operaciones se cuentan para la prueba comparativa, aunque en realidad no forman parte del proceso de consulta.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-224">As the methods instantiate and dispose the context within the method, these operations are counted for the benchmark, although strictly speaking they are not part of the querying process.</span></span> <span data-ttu-id="7cdd6-225">Esto no es importante si el objetivo es comparar dos alternativas entre sí (dado que la creación de instancias del contexto y la eliminación son iguales) y proporciona una medida más holística para toda la operación.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-225">This should not matter if the goal is to compare two alternatives to one another (since the context instantiation and disposal are the same), and gives a more holistic measurement for the entire operation.</span></span>

<span data-ttu-id="7cdd6-226">Una limitación de BenchmarkDotNet es que mide el rendimiento sencillo de un único subproceso de los métodos proporcionados y, por tanto, no es adecuado para escenarios de pruebas comparativas.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-226">One limitation of BenchmarkDotNet is that it measures simple, single-thread performance of the methods you provide, and is therefore not well-suited for benchmarking concurrent scenarios.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="7cdd6-227">Asegúrese siempre de que los datos de la base de datos son similares a los datos de producción al realizar pruebas comparativas; de lo contrario, los resultados de las pruebas comparativas pueden no representar el rendimiento real en producción.</span><span class="sxs-lookup"><span data-stu-id="7cdd6-227">Always make sure to have data in your database that is similar to production data when benchmarking, otherwise the benchmark results may not represent actual performance in production.</span></span>
